<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"ldmzw.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":true,"nav":{"gitalk":{"order":-2}}},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="概述在前面的文章中，我们已经介绍了logback的Logger组件，本篇文章将主要介绍Appender组件。  Logback 官网 Logback 使用手册 Logback Appender使用手册  系列相关文章：  日志组件 日志组件Logback 日志组件动态日志 日志组件Logback之Logger 日志组件Logback之Appender 日志组件Logback之Layout 日志组件">
<meta property="og:type" content="article">
<meta property="og:title" content="日志组件Logback之Appender">
<meta property="og:url" content="http://ldmzw.github.io/2022/04/25/log-logback3/index.html">
<meta property="og:site_name" content="ldmzw">
<meta property="og:description" content="概述在前面的文章中，我们已经介绍了logback的Logger组件，本篇文章将主要介绍Appender组件。  Logback 官网 Logback 使用手册 Logback Appender使用手册  系列相关文章：  日志组件 日志组件Logback 日志组件动态日志 日志组件Logback之Logger 日志组件Logback之Appender 日志组件Logback之Layout 日志组件">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://ldmzw.github.io/2022/04/25/log-logback3/001.png">
<meta property="og:image" content="http://ldmzw.github.io/2022/04/25/log-logback3/002.png">
<meta property="article:published_time" content="2022-04-25T12:07:15.000Z">
<meta property="article:modified_time" content="2022-05-16T02:37:42.303Z">
<meta property="article:author" content="victor min">
<meta property="article:tag" content="java">
<meta property="article:tag" content="日志组件">
<meta property="article:tag" content="logback">
<meta property="article:tag" content="appender">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://ldmzw.github.io/2022/04/25/log-logback3/001.png">

<link rel="canonical" href="http://ldmzw.github.io/2022/04/25/log-logback3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>日志组件Logback之Appender | ldmzw</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?871d14f3134a97b6f6c8ad66f8875178";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ldmzw</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">趣谈闲记</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/ldmzw" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://ldmzw.github.io/2022/04/25/log-logback3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="victor min">
      <meta itemprop="description" content="风无定，人无常<br/>人生如浮萍，聚散两茫茫">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ldmzw">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          日志组件Logback之Appender
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-25 20:07:15" itemprop="dateCreated datePublished" datetime="2022-04-25T20:07:15+08:00">2022-04-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-16 10:37:42" itemprop="dateModified" datetime="2022-05-16T10:37:42+08:00">2022-05-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/%E6%97%A5%E5%BF%97%E7%BB%84%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">日志组件</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/%E6%97%A5%E5%BF%97%E7%BB%84%E4%BB%B6/logback/" itemprop="url" rel="index"><span itemprop="name">logback</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>在前面的文章中，我们已经介绍了<code>logback</code>的<code>Logger</code>组件，本篇文章将主要介绍<code>Appender</code>组件。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://logback.qos.ch/" title="Logback 官网">Logback 官网</a></li>
<li><a target="_blank" rel="noopener" href="https://logback.qos.ch/manual/index.html" title="Logback 使用手册">Logback 使用手册</a></li>
<li><a target="_blank" rel="noopener" href="https://logback.qos.ch/manual/appenders.html" title="Logback Appender使用手册">Logback Appender使用手册</a></li>
</ul>
<p>系列相关文章：</p>
<ul>
<li><a href="/2022/02/28/log-framework/" title="日志组件">日志组件</a></li>
<li><a href="/2022/03/07/log-logback/" title="日志组件Logback">日志组件Logback</a></li>
<li><a href="/2022/03/21/log-framework1/" title="日志组件动态日志">日志组件动态日志</a></li>
<li><a href="/2022/04/18/log-logback2/" title="日志组件Logback之Logger">日志组件Logback之Logger</a></li>
<li><a href="/2022/04/25/log-logback3/" title="日志组件Logback之Appender">日志组件Logback之Appender</a></li>
<li><a href="/2022/05/02/log-logback4/" title="日志组件Logback之Layout">日志组件Logback之Layout</a></li>
<li><a href="/2022/05/09/log-logback5/" title="日志组件Logback之Filter">日志组件Logback之Filter</a></li>
<li><a href="/2022/05/16/log-logback6/" title="日志组件Logback之配置加载">日志组件Logback之配置加载</a></li>
</ul>
<span id="more"></span>

<h2 id="源码解读"><a href="#源码解读" class="headerlink" title="源码解读"></a>源码解读</h2><p>开发者在使用<code>logback</code>时，我们直接操作的是<code>logger</code>实例，但是真正记录消息事件的操作却不是<code>logger</code>来实现的，而是委托给<code>appender</code>来操作的。</p>
<p><img src="/2022/04/25/log-logback3/001.png" alt="Appender 类图" title="Appender 类图"></p>
<h3 id="Appender"><a href="#Appender" class="headerlink" title="Appender"></a>Appender</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ch.qos.logback.core;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ch.qos.logback.core.spi.ContextAware;</span><br><span class="line"><span class="keyword">import</span> ch.qos.logback.core.spi.FilterAttachable;</span><br><span class="line"><span class="keyword">import</span> ch.qos.logback.core.spi.LifeCycle;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Appender</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">LifeCycle</span>, <span class="title">ContextAware</span>, <span class="title">FilterAttachable</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the name of this appender. The name uniquely identifies the appender.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">getName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This is where an appender accomplishes its work. Note that the argument </span></span><br><span class="line"><span class="comment">     * is of type Object.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> event</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doAppend</span><span class="params">(E event)</span> <span class="keyword">throws</span> LogbackException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set the name of this appender. The name is used by other components to</span></span><br><span class="line"><span class="comment">     * identify this appender.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从<code>appender</code>的源码中我们不难发现，其主要是通过<code>doAppend</code>来记录消息的。</p>
<h3 id="AppenderBase"><a href="#AppenderBase" class="headerlink" title="AppenderBase"></a>AppenderBase</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 源码 ch.qos.logback.core.AppenderBase</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppenderBase</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">ContextAwareBase</span> <span class="keyword">implements</span> <span class="title">Appender</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> started = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The guard prevents an appender from repeatedly calling its own doAppend</span></span><br><span class="line"><span class="comment">     * method.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> guard = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Appenders are named.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> FilterAttachableImpl&lt;E&gt; fai = <span class="keyword">new</span> FilterAttachableImpl&lt;E&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> statusRepeatCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> exceptionCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ALLOWED_REPEATS = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">doAppend</span><span class="params">(E eventObject)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// WARNING: The guard check MUST be the first statement in the</span></span><br><span class="line">        <span class="comment">// doAppend() method.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// prevent re-entry.</span></span><br><span class="line">        <span class="keyword">if</span> (guard) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            guard = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.started) &#123;</span><br><span class="line">                <span class="keyword">if</span> (statusRepeatCount++ &lt; ALLOWED_REPEATS) &#123;</span><br><span class="line">                    addStatus(<span class="keyword">new</span> WarnStatus(<span class="string">&quot;Attempted to append to non started appender [&quot;</span> + name + <span class="string">&quot;].&quot;</span>, <span class="keyword">this</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (getFilterChainDecision(eventObject) == FilterReply.DENY) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ok, we now invoke derived class&#x27; implementation of append</span></span><br><span class="line">            <span class="keyword">this</span>.append(eventObject);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (exceptionCount++ &lt; ALLOWED_REPEATS) &#123;</span><br><span class="line">                addError(<span class="string">&quot;Appender [&quot;</span> + name + <span class="string">&quot;] failed to append.&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            guard = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">append</span><span class="params">(E eventObject)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set the name of this appender.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        started = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        started = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isStarted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> started;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getClass().getName() + <span class="string">&quot;[&quot;</span> + name + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFilter</span><span class="params">(Filter&lt;E&gt; newFilter)</span> </span>&#123;</span><br><span class="line">        fai.addFilter(newFilter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearAllFilters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        fai.clearAllFilters();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Filter&lt;E&gt;&gt; getCopyOfAttachedFiltersList() &#123;</span><br><span class="line">        <span class="keyword">return</span> fai.getCopyOfAttachedFiltersList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterReply <span class="title">getFilterChainDecision</span><span class="params">(E event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fai.getFilterChainDecision(event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从源码中我们可以看出，<code>doAppend</code>是<code>synchronized</code>，因此在多线程的环境下是安全的，它的派生类不需要去处理多线程问题。<code>AppenderBase</code>提供了许多基础的方法供所有的<code>appender</code>来使用。</p>
<p><code>AppenderBase</code>的派生类有：</p>
<ul>
<li>SocketAppender与SSLSocketAppender：将日志事件序列化后通tcp方式传送到远程日志服务中心</li>
<li>ServerSocketAppender与SSLServerSocketAppender：与SocketAppender相反，ServerSocketAppender是作为服务端</li>
<li>NOPAppender：不进行任何操作</li>
<li>SyslogAppender：系统日志</li>
<li>SMTPAppender：将日志事件通过邮件的方式发送到配置的邮箱</li>
<li>SiftingAppender：可以根据日志事件按配置的鉴别方式将日志事件委托到真正的appender上</li>
<li>CyclicBufferAppender：将日志事件加入CyclicBuffer，从名称我们可以看出，它只会保留最新的部分日志事件</li>
<li>ListAppender：将日志事件加入list</li>
</ul>
<h4 id="SocketAppender与SSLSocketAppender"><a href="#SocketAppender与SSLSocketAppender" class="headerlink" title="SocketAppender与SSLSocketAppender"></a>SocketAppender与SSLSocketAppender</h4><p><code>SocketAppender</code>允许我们将日志事件通过tcp的方式远程传送到其它的日志服务中心。<code>logbakc</code>实现了两个简单的日志事件接收服务<code>ch.qos.logback.classic.net.SimpleSocketServer</code>与<code>ch.qos.logback.classic.net.server.ServerSocketReceiver</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 源码 ch.qos.logback.core.net.AbstractSocketAppender</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractSocketAppender</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AppenderBase</span>&lt;<span class="title">E</span>&gt; <span class="keyword">implements</span> <span class="title">SocketConnector</span>.<span class="title">ExceptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The default port number of remote logging server (4560).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_PORT = <span class="number">4560</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The default reconnection delay (30000 milliseconds or 30 seconds).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_RECONNECTION_DELAY = <span class="number">30000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Default size of the deque used to hold logging events that are destined</span></span><br><span class="line"><span class="comment">     * for the remote peer.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_QUEUE_SIZE = <span class="number">128</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Default timeout when waiting for the remote server to accept our</span></span><br><span class="line"><span class="comment">     * connection.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_ACCEPT_CONNECTION_DELAY = <span class="number">5000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Default timeout for how long to wait when inserting an event into</span></span><br><span class="line"><span class="comment">     * the BlockingQueue.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_EVENT_DELAY_TIMEOUT = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectWriterFactory objectWriterFactory;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> QueueFactory queueFactory;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String remoteHost;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port = DEFAULT_PORT;</span><br><span class="line">    <span class="keyword">private</span> InetAddress address;</span><br><span class="line">    <span class="keyword">private</span> Duration reconnectionDelay = <span class="keyword">new</span> Duration(DEFAULT_RECONNECTION_DELAY);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> queueSize = DEFAULT_QUEUE_SIZE;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> acceptConnectionTimeout = DEFAULT_ACCEPT_CONNECTION_DELAY;</span><br><span class="line">    <span class="keyword">private</span> Duration eventDelayLimit = <span class="keyword">new</span> Duration(DEFAULT_EVENT_DELAY_TIMEOUT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BlockingDeque&lt;E&gt; deque;</span><br><span class="line">    <span class="keyword">private</span> String peerId;</span><br><span class="line">    <span class="keyword">private</span> SocketConnector connector;</span><br><span class="line">    <span class="keyword">private</span> Future&lt;?&gt; task;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Socket socket;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructs a new appender.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">AbstractSocketAppender</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">new</span> QueueFactory(), <span class="keyword">new</span> ObjectWriterFactory());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructs a new appender using the given &#123;<span class="doctag">@link</span> QueueFactory&#125; and &#123;<span class="doctag">@link</span> ObjectWriterFactory&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    AbstractSocketAppender(QueueFactory queueFactory, ObjectWriterFactory objectWriterFactory) &#123;</span><br><span class="line">        <span class="keyword">this</span>.objectWriterFactory = objectWriterFactory;</span><br><span class="line">        <span class="keyword">this</span>.queueFactory = queueFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isStarted())</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">int</span> errorCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (port &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            errorCount++;</span><br><span class="line">            addError(<span class="string">&quot;No port was configured for appender&quot;</span> + name + <span class="string">&quot; For more information, please visit http://logback.qos.ch/codes.html#socket_no_port&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (remoteHost == <span class="keyword">null</span>) &#123;</span><br><span class="line">            errorCount++;</span><br><span class="line">            addError(<span class="string">&quot;No remote host was configured for appender&quot;</span> + name</span><br><span class="line">                            + <span class="string">&quot; For more information, please visit http://logback.qos.ch/codes.html#socket_no_host&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (queueSize == <span class="number">0</span>) &#123;</span><br><span class="line">            addWarn(<span class="string">&quot;Queue size of zero is deprecated, use a size of one to indicate synchronous processing&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (queueSize &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            errorCount++;</span><br><span class="line">            addError(<span class="string">&quot;Queue size must be greater than zero&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (errorCount == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                address = InetAddress.getByName(remoteHost);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UnknownHostException ex) &#123;</span><br><span class="line">                addError(<span class="string">&quot;unknown host: &quot;</span> + remoteHost);</span><br><span class="line">                errorCount++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (errorCount == <span class="number">0</span>) &#123;</span><br><span class="line">            deque = queueFactory.newLinkedBlockingDeque(queueSize);</span><br><span class="line">            peerId = <span class="string">&quot;remote peer &quot;</span> + remoteHost + <span class="string">&quot;:&quot;</span> + port + <span class="string">&quot;: &quot;</span>;</span><br><span class="line">            connector = createConnector(address, port, <span class="number">0</span>, reconnectionDelay.getMilliseconds());</span><br><span class="line">            task = getContext().getExecutorService().submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    connectSocketAndDispatchEvents();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">super</span>.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!isStarted())</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        CloseUtil.closeQuietly(socket);</span><br><span class="line">        task.cancel(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">super</span>.stop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">append</span><span class="params">(E event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (event == <span class="keyword">null</span> || !isStarted())</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> inserted = deque.offer(event, eventDelayLimit.getMilliseconds(), TimeUnit.MILLISECONDS);</span><br><span class="line">            <span class="keyword">if</span> (!inserted) &#123;</span><br><span class="line">                addInfo(<span class="string">&quot;Dropping event due to timeout limit of [&quot;</span> + eventDelayLimit + <span class="string">&quot;] being exceeded&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            addError(<span class="string">&quot;Interrupted while appending event to SocketAppender&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">connectSocketAndDispatchEvents</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (socketConnectionCouldBeEstablished()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ObjectWriter objectWriter = createObjectWriterForSocket();</span><br><span class="line">                    addInfo(peerId + <span class="string">&quot;connection established&quot;</span>);</span><br><span class="line">                    dispatchEvents(objectWriter);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (javax.net.ssl.SSLHandshakeException she) &#123;</span><br><span class="line">                	<span class="comment">// FIXME </span></span><br><span class="line">                    Thread.sleep(DEFAULT_RECONNECTION_DELAY);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">                    addInfo(peerId + <span class="string">&quot;connection failed: &quot;</span>, ex);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    CloseUtil.closeQuietly(socket);</span><br><span class="line">                    socket = <span class="keyword">null</span>;</span><br><span class="line">                    addInfo(peerId + <span class="string">&quot;connection closed&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">            <span class="keyword">assert</span> <span class="keyword">true</span>; <span class="comment">// ok... we&#x27;ll exit now</span></span><br><span class="line">        &#125;</span><br><span class="line">        addInfo(<span class="string">&quot;shutting down&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">socketConnectionCouldBeEstablished</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (socket = connector.call()) != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ObjectWriter <span class="title">createObjectWriterForSocket</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        socket.setSoTimeout(acceptConnectionTimeout);</span><br><span class="line">        ObjectWriter objectWriter = objectWriterFactory.newAutoFlushingObjectWriter(socket.getOutputStream());</span><br><span class="line">        socket.setSoTimeout(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> objectWriter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> SocketConnector <span class="title">createConnector</span><span class="params">(InetAddress address, <span class="keyword">int</span> port, <span class="keyword">int</span> initialDelay, <span class="keyword">long</span> retryDelay)</span> </span>&#123;</span><br><span class="line">        SocketConnector connector = newConnector(address, port, initialDelay, retryDelay);</span><br><span class="line">        connector.setExceptionHandler(<span class="keyword">this</span>);</span><br><span class="line">        connector.setSocketFactory(getSocketFactory());</span><br><span class="line">        <span class="keyword">return</span> connector;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchEvents</span><span class="params">(ObjectWriter objectWriter)</span> <span class="keyword">throws</span> InterruptedException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            E event = deque.takeFirst();</span><br><span class="line">            postProcessEvent(event);</span><br><span class="line">            Serializable serializableEvent = getPST().transform(event);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                objectWriter.write(serializableEvent);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                tryReAddingEventToFrontOfQueue(event);</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">tryReAddingEventToFrontOfQueue</span><span class="params">(E event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> wasInserted = deque.offerFirst(event);</span><br><span class="line">        <span class="keyword">if</span> (!wasInserted) &#123;</span><br><span class="line">            addInfo(<span class="string">&quot;Dropping event due to socket connection error and maxed out deque capacity&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connectionFailed</span><span class="params">(SocketConnector connector, Exception ex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> InterruptedException) &#123;</span><br><span class="line">            addInfo(<span class="string">&quot;connector interrupted&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> ConnectException) &#123;</span><br><span class="line">            addInfo(peerId + <span class="string">&quot;connection refused&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            addInfo(peerId + ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们知道，<code>SocketAppender</code>与<code>SSLSocketAppender</code>是将日志事件通过tcp传送到远程日志服务上，由于网络的不稳定等因素，从源码中可以看出，appender会将日志事件缓存到本地的队列中以防止网络的波动。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">          </span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;SOCKET&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.net.SocketAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">remoteHost</span>&gt;</span>$&#123;host&#125;<span class="tag">&lt;/<span class="name">remoteHost</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">port</span>&gt;</span>$&#123;port&#125;<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">reconnectionDelay</span>&gt;</span>10000<span class="tag">&lt;/<span class="name">reconnectionDelay</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">includeCallerData</span>&gt;</span>$&#123;includeCallerData&#125;<span class="tag">&lt;/<span class="name">includeCallerData</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;SOCKET&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">root</span>&gt;</span>  </span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>


<h4 id="ServerSocketAppender与SSLServerSocketAppender"><a href="#ServerSocketAppender与SSLServerSocketAppender" class="headerlink" title="ServerSocketAppender与SSLServerSocketAppender"></a>ServerSocketAppender与SSLServerSocketAppender</h4><p><code>ServerSocketAppender</code>与<code>SocketAppender</code>思路正好相反，我们知道<code>SocketAppender</code>是作为客户端，是在我们应用启动的时候会去连接远程服务，会将本地的日志事件传输到远程，但是有时候远程服务并不一定已经存在。而<code>ServerSocketAppender</code>则是以自身为服务端，当启动服务后，如果有远程客户端连接上来，则会将本的地日志事件传输到所有与它连接的远程客户端上。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 源码 ch.qos.logback.core.net.server.AbstractServerSocketAppender</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractServerSocketAppender</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AppenderBase</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Default &#123;<span class="doctag">@link</span> ServerSocket&#125; backlog</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_BACKLOG = <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * Default queue size used for each client</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_CLIENT_QUEUE_SIZE = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port = AbstractSocketAppender.DEFAULT_PORT;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> backlog = DEFAULT_BACKLOG;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> clientQueueSize = DEFAULT_CLIENT_QUEUE_SIZE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ServerRunner&lt;RemoteReceiverClient&gt; runner;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isStarted())</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ServerSocket socket = getServerSocketFactory().createServerSocket(getPort(), getBacklog(), getInetAddress());</span><br><span class="line">            ServerListener&lt;RemoteReceiverClient&gt; listener = createServerListener(socket);</span><br><span class="line"></span><br><span class="line">            runner = createServerRunner(listener, getContext().getExecutorService());</span><br><span class="line">            runner.setContext(getContext());</span><br><span class="line">            getContext().getExecutorService().execute(runner);</span><br><span class="line">            <span class="keyword">super</span>.start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            addError(<span class="string">&quot;server startup error: &quot;</span> + ex, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ServerListener&lt;RemoteReceiverClient&gt; <span class="title">createServerListener</span><span class="params">(ServerSocket socket)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RemoteReceiverServerListener(socket);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ServerRunner&lt;RemoteReceiverClient&gt; <span class="title">createServerRunner</span><span class="params">(ServerListener&lt;RemoteReceiverClient&gt; listener, Executor executor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RemoteReceiverServerRunner(listener, executor, getClientQueueSize());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!isStarted())</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            runner.stop();</span><br><span class="line">            <span class="keyword">super</span>.stop();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            addError(<span class="string">&quot;server shutdown error: &quot;</span> + ex, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">append</span><span class="params">(E event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (event == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        postProcessEvent(event);</span><br><span class="line">        <span class="keyword">final</span> Serializable serEvent = getPST().transform(event);</span><br><span class="line">        runner.accept(<span class="keyword">new</span> ClientVisitor&lt;RemoteReceiverClient&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(RemoteReceiverClient client)</span> </span>&#123;</span><br><span class="line">                client.offer(serEvent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">debug</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;SERVER&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.net.server.SSLServerSocketAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">port</span>&gt;</span>$&#123;port&#125;<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">includeCallerData</span>&gt;</span>$&#123;includeCallerData&#125;<span class="tag">&lt;/<span class="name">includeCallerData</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ssl</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">keyStore</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">location</span>&gt;</span>$&#123;keystore&#125;<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">password</span>&gt;</span>$&#123;password&#125;<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">keyStore</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ssl</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;debug&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;SERVER&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">root</span>&gt;</span>  </span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="SMTPAppender"><a href="#SMTPAppender" class="headerlink" title="SMTPAppender"></a>SMTPAppender</h4><p>在日常使用中，我们除了使用<code>socket</code>来传送日志事件外，我们还有可能会使用邮件来传送日志事件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 源码 ch.qos.logback.core.net.SMTPAppenderBase</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">SMTPAppenderBase</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AppenderBase</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> InternetAddress[] EMPTY_IA_ARRAY = <span class="keyword">new</span> InternetAddress[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MAX_DELAY_BETWEEN_STATUS_MESSAGES = <span class="number">1228800000L</span>;</span><br><span class="line">    <span class="keyword">long</span> lastTrackerStatusPrint = <span class="number">0L</span>;</span><br><span class="line">    <span class="keyword">long</span> delayBetweenStatusMessages = <span class="number">300000L</span>;</span><br><span class="line">    <span class="keyword">protected</span> Layout&lt;E&gt; subjectLayout;</span><br><span class="line">    <span class="keyword">protected</span> Layout&lt;E&gt; layout;</span><br><span class="line">    <span class="keyword">private</span> List&lt;PatternLayoutBase&lt;E&gt;&gt; toPatternLayoutList = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    <span class="keyword">private</span> String from;</span><br><span class="line">    <span class="keyword">private</span> String subjectStr = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> String smtpHost;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> smtpPort = <span class="number">25</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> starttls = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> ssl = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> sessionViaJNDI = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> String jndiLocation = <span class="string">&quot;java:comp/env/mail/Session&quot;</span>;</span><br><span class="line">    String username;</span><br><span class="line">    String password;</span><br><span class="line">    String localhost;</span><br><span class="line">    <span class="keyword">boolean</span> asynchronousSending = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> String charsetEncoding = <span class="string">&quot;UTF-8&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> Session session;</span><br><span class="line">    <span class="keyword">protected</span> EventEvaluator&lt;E&gt; eventEvaluator;</span><br><span class="line">    <span class="keyword">protected</span> Discriminator&lt;E&gt; discriminator = <span class="keyword">new</span> DefaultDiscriminator();</span><br><span class="line">    <span class="keyword">protected</span> CyclicBufferTracker&lt;E&gt; cbTracker;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> errorCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SMTPAppenderBase</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Layout&lt;E&gt; <span class="title">makeSubjectLayout</span><span class="params">(String var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.cbTracker == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.cbTracker = <span class="keyword">new</span> CyclicBufferTracker();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.sessionViaJNDI) &#123;</span><br><span class="line">            <span class="keyword">this</span>.session = <span class="keyword">this</span>.lookupSessionInJNDI();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.session = <span class="keyword">this</span>.buildSessionFromProperties();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.session == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.addError(<span class="string">&quot;Failed to obtain javax.mail.Session. Cannot start.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.subjectLayout = <span class="keyword">this</span>.makeSubjectLayout(<span class="keyword">this</span>.subjectStr);</span><br><span class="line">            <span class="keyword">this</span>.started = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Session <span class="title">lookupSessionInJNDI</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.addInfo(<span class="string">&quot;Looking up javax.mail.Session at JNDI location [&quot;</span> + <span class="keyword">this</span>.jndiLocation + <span class="string">&quot;]&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Context initialContext = JNDIUtil.getInitialContext();</span><br><span class="line">            Object obj = JNDIUtil.lookupObject(initialContext, <span class="keyword">this</span>.jndiLocation);</span><br><span class="line">            <span class="keyword">return</span> (Session)obj;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var3) &#123;</span><br><span class="line">            <span class="keyword">this</span>.addError(<span class="string">&quot;Failed to obtain javax.mail.Session from JNDI location [&quot;</span> + <span class="keyword">this</span>.jndiLocation + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Session <span class="title">buildSessionFromProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Properties props = <span class="keyword">new</span> Properties(OptionHelper.getSystemProperties());</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.smtpHost != <span class="keyword">null</span>) &#123;</span><br><span class="line">            props.put(<span class="string">&quot;mail.smtp.host&quot;</span>, <span class="keyword">this</span>.smtpHost);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        props.put(<span class="string">&quot;mail.smtp.port&quot;</span>, Integer.toString(<span class="keyword">this</span>.smtpPort));</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.localhost != <span class="keyword">null</span>) &#123;</span><br><span class="line">            props.put(<span class="string">&quot;mail.smtp.localhost&quot;</span>, <span class="keyword">this</span>.localhost);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        LoginAuthenticator loginAuthenticator = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (!OptionHelper.isEmpty(<span class="keyword">this</span>.username)) &#123;</span><br><span class="line">            loginAuthenticator = <span class="keyword">new</span> LoginAuthenticator(<span class="keyword">this</span>.username, <span class="keyword">this</span>.password);</span><br><span class="line">            props.put(<span class="string">&quot;mail.smtp.auth&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.isSTARTTLS() &amp;&amp; <span class="keyword">this</span>.isSSL()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.addError(<span class="string">&quot;Both SSL and StartTLS cannot be enabled simultaneously&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.isSTARTTLS()) &#123;</span><br><span class="line">                props.put(<span class="string">&quot;mail.smtp.starttls.enable&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.isSSL()) &#123;</span><br><span class="line">                String SSL_FACTORY = <span class="string">&quot;javax.net.ssl.SSLSocketFactory&quot;</span>;</span><br><span class="line">                props.put(<span class="string">&quot;mail.smtp.socketFactory.port&quot;</span>, Integer.toString(<span class="keyword">this</span>.smtpPort));</span><br><span class="line">                props.put(<span class="string">&quot;mail.smtp.socketFactory.class&quot;</span>, SSL_FACTORY);</span><br><span class="line">                props.put(<span class="string">&quot;mail.smtp.socketFactory.fallback&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Session.getInstance(props, loginAuthenticator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">append</span><span class="params">(E eventObject)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.checkEntryConditions()) &#123;</span><br><span class="line">            String key = <span class="keyword">this</span>.discriminator.getDiscriminatingValue(eventObject);</span><br><span class="line">            <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">            CyclicBuffer&lt;E&gt; cb = (CyclicBuffer)<span class="keyword">this</span>.cbTracker.getOrCreate(key, now);</span><br><span class="line">            <span class="keyword">this</span>.subAppend(cb, eventObject);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.eventEvaluator.evaluate(eventObject)) &#123;</span><br><span class="line">                    CyclicBuffer&lt;E&gt; cbClone = <span class="keyword">new</span> CyclicBuffer(cb);</span><br><span class="line">                    cb.clear();</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.asynchronousSending) &#123;</span><br><span class="line">                        SMTPAppenderBase&lt;E&gt;.SenderRunnable senderRunnable = <span class="keyword">new</span> SMTPAppenderBase.SenderRunnable(cbClone, eventObject);</span><br><span class="line">                        <span class="keyword">this</span>.context.getScheduledExecutorService().execute(senderRunnable);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">this</span>.sendBuffer(cbClone, eventObject);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (EvaluationException var8) &#123;</span><br><span class="line">                ++<span class="keyword">this</span>.errorCount;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.errorCount &lt; <span class="number">4</span>) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.addError(<span class="string">&quot;SMTPAppender&#x27;s EventEvaluator threw an Exception-&quot;</span>, var8);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.eventMarksEndOfLife(eventObject)) &#123;</span><br><span class="line">                <span class="keyword">this</span>.cbTracker.endOfLife(key);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.cbTracker.removeStaleComponents(now);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.lastTrackerStatusPrint + <span class="keyword">this</span>.delayBetweenStatusMessages &lt; now) &#123;</span><br><span class="line">                <span class="keyword">this</span>.addInfo(<span class="string">&quot;SMTPAppender [&quot;</span> + <span class="keyword">this</span>.name + <span class="string">&quot;] is tracking [&quot;</span> + <span class="keyword">this</span>.cbTracker.getComponentCount() + <span class="string">&quot;] buffers&quot;</span>);</span><br><span class="line">                <span class="keyword">this</span>.lastTrackerStatusPrint = now;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.delayBetweenStatusMessages &lt; <span class="number">1228800000L</span>) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.delayBetweenStatusMessages *= <span class="number">4L</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span>   </span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;EMAIL&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.net.SMTPAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">smtpHost</span>&gt;</span>smtp.gmail.com<span class="tag">&lt;/<span class="name">smtpHost</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">smtpPort</span>&gt;</span>587<span class="tag">&lt;/<span class="name">smtpPort</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">STARTTLS</span>&gt;</span>true<span class="tag">&lt;/<span class="name">STARTTLS</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">username</span>&gt;</span>YOUR_USERNAME@gmail.com<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">password</span>&gt;</span>YOUR_GMAIL_PASSWORD<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">to</span>&gt;</span>EMAIL-DESTINATION<span class="tag">&lt;/<span class="name">to</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">to</span>&gt;</span>ANOTHER_EMAIL_DESTINATION<span class="tag">&lt;/<span class="name">to</span>&gt;</span> <span class="comment">&lt;!-- additional destinations are possible --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">from</span>&gt;</span>YOUR_USERNAME@gmail.com<span class="tag">&lt;/<span class="name">from</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">subject</span>&gt;</span>TESTING: %logger&#123;20&#125; - %m<span class="tag">&lt;/<span class="name">subject</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">layout</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.PatternLayout&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%-4relative [%thread] %-5level %logger&#123;30&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">layout</span>&gt;</span>       </span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;EMAIL&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">root</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="SiftingAppender"><a href="#SiftingAppender" class="headerlink" title="SiftingAppender"></a>SiftingAppender</h4><p><code>SiftingAppender</code>并不会真正的去记录日志事件，它会根据我们配置的策略将日志事件委派到具体的appender上。通过<code>SiftingAppender</code>，我们可以根据日志事件的某些属性将日志事件记录到不同的appender上。</p>
<p>举例，我们有一个任务处理系统，每个任务有自己的任务号并处理的时间相对来说比较长，如果我们希望在页面应用上查看任务的处理日志，这时我们就可以使用<code>SiftingAppender</code>来实现。如果我们使用<code>FileAppender</code>或者<code>RollingFileAppender</code>来记录日志，这时所有的任务日志都是在同一个文件中，如果我们需要提取某一个任务的日志，我们也许会使用<code>grep</code>等命令来提取，如果我们直接使用<code>SiftingAppender</code>根据任务号将日志记录到不同的文件中，我们只需要根据任务号查找到对应的文件就能提取出该任务的日志。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 源码 ch.qos.logback.core.sift.SiftingAppenderBase</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">SiftingAppenderBase</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AppenderBase</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> AppenderTracker&lt;E&gt; appenderTracker;</span><br><span class="line">    AppenderFactory&lt;E&gt; appenderFactory;</span><br><span class="line">    Duration timeout = <span class="keyword">new</span> Duration(AppenderTracker.DEFAULT_TIMEOUT);</span><br><span class="line">    <span class="keyword">int</span> maxAppenderCount = AppenderTracker.DEFAULT_MAX_COMPONENTS;</span><br><span class="line"></span><br><span class="line">    Discriminator&lt;E&gt; discriminator;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Duration <span class="title">getTimeout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> timeout;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTimeout</span><span class="params">(Duration timeout)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.timeout = timeout;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMaxAppenderCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> maxAppenderCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMaxAppenderCount</span><span class="params">(<span class="keyword">int</span> maxAppenderCount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.maxAppenderCount = maxAppenderCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This setter is intended to be invoked by SiftAction. Customers have no reason to invoke</span></span><br><span class="line"><span class="comment">     * this method directly.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAppenderFactory</span><span class="params">(AppenderFactory&lt;E&gt; appenderFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.appenderFactory = appenderFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> errors = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (discriminator == <span class="keyword">null</span>) &#123;</span><br><span class="line">            addError(<span class="string">&quot;Missing discriminator. Aborting&quot;</span>);</span><br><span class="line">            errors++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!discriminator.isStarted()) &#123;</span><br><span class="line">            addError(<span class="string">&quot;Discriminator has not started successfully. Aborting&quot;</span>);</span><br><span class="line">            errors++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (appenderFactory == <span class="keyword">null</span>) &#123;</span><br><span class="line">            addError(<span class="string">&quot;AppenderFactory has not been set. Aborting&quot;</span>);</span><br><span class="line">            errors++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            appenderTracker = <span class="keyword">new</span> AppenderTracker&lt;E&gt;(context, appenderFactory);</span><br><span class="line">            appenderTracker.setMaxComponents(maxAppenderCount);</span><br><span class="line">            appenderTracker.setTimeout(timeout.getMilliseconds());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (errors == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">super</span>.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Appender&lt;E&gt; appender : appenderTracker.allComponents()) &#123;</span><br><span class="line">            appender.stop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">protected</span> <span class="keyword">long</span> <span class="title">getTimestamp</span><span class="params">(E event)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">append</span><span class="params">(E event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!isStarted()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String discriminatingValue = discriminator.getDiscriminatingValue(event);</span><br><span class="line">        <span class="keyword">long</span> timestamp = getTimestamp(event);</span><br><span class="line"></span><br><span class="line">        Appender&lt;E&gt; appender = appenderTracker.getOrCreate(discriminatingValue, timestamp);</span><br><span class="line">        <span class="comment">// marks the appender for removal as specified by the user</span></span><br><span class="line">        <span class="keyword">if</span> (eventMarksEndOfLife(event)) &#123;</span><br><span class="line">            appenderTracker.endOfLife(discriminatingValue);</span><br><span class="line">        &#125;</span><br><span class="line">        appenderTracker.removeStaleComponents(timestamp);</span><br><span class="line">        appender.doAppend(event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">eventMarksEndOfLife</span><span class="params">(E event)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Discriminator&lt;E&gt; <span class="title">getDiscriminator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> discriminator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDiscriminator</span><span class="params">(Discriminator&lt;E&gt; discriminator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.discriminator = discriminator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sometimes one needs to close a nested appender immediately</span></span><br><span class="line">    <span class="comment">// for example when executing a command which has its own nested appender</span></span><br><span class="line">    <span class="comment">// and the command also cleans up after itself. However, an open file appender</span></span><br><span class="line">    <span class="comment">// will prevent the folder from being deleted</span></span><br><span class="line">    <span class="comment">// see http://www.qos.ch/pipermail/logback-user/2010-March/001487.html</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 0.9.19</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AppenderTracker&lt;E&gt; <span class="title">getAppenderTracker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> appenderTracker;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDiscriminatorKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (discriminator != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> discriminator.getKey();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 源码 ch.qos.logback.classic.sift.SiftingAppender</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SiftingAppender</span> <span class="keyword">extends</span> <span class="title">SiftingAppenderBase</span>&lt;<span class="title">ILoggingEvent</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">long</span> <span class="title">getTimestamp</span><span class="params">(ILoggingEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> event.getTimeStamp();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@DefaultClass(MDCBasedDiscriminator.class)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDiscriminator</span><span class="params">(Discriminator&lt;ILoggingEvent&gt; discriminator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.setDiscriminator(discriminator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">eventMarksEndOfLife</span><span class="params">(ILoggingEvent event)</span> </span>&#123;</span><br><span class="line">        Marker marker = event.getMarker();</span><br><span class="line">        <span class="keyword">if</span> (marker == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> marker.contains(ClassicConstants.FINALIZE_SESSION_MARKER);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;SIFT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.sift.SiftingAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- in the absence of the class attribute, it is assumed that the</span></span><br><span class="line"><span class="comment">         desired discriminator type is</span></span><br><span class="line"><span class="comment">         ch.qos.logback.classic.sift.MDCBasedDiscriminator --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">discriminator</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">key</span>&gt;</span>userid<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">defaultValue</span>&gt;</span>unknown<span class="tag">&lt;/<span class="name">defaultValue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">discriminator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sift</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;FILE-$&#123;userid&#125;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.FileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;userid&#125;.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">append</span>&gt;</span>false<span class="tag">&lt;/<span class="name">append</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">layout</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.PatternLayout&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%-4relative [%thread] %-5level %logger&#123;30&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">sift</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;SIFT&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>SiftingAppender</code>是根据<code>discriminator</code>来进行日志事件分发的，从源码中我们可以看到，如果我们没有去指定我们自己的<code>discriminator</code>，则默认会采用<code>ch.qos.logback.classic.sift.MDCBasedDiscriminator</code>。</p>
<h4 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h4><p>其它的appender，如<code>NOPAppender</code>、<code>SyslogAppender</code>、<code>CyclicBufferAppender</code>与<code>ListAppender</code>，平常使用都比较少，大家可以去官网查看详细的讲解。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://logback.qos.ch/manual/appenders.html" title="NOPAppender 文档">NOPAppender 文档</a></li>
<li><a target="_blank" rel="noopener" href="https://logback.qos.ch/manual/appenders.html#SyslogAppender" title="SyslogAppender 文档">SyslogAppender 文档</a></li>
<li><a target="_blank" rel="noopener" href="https://logback.qos.ch/manual/appenders.html" title="CyclicBufferAppender 文档">CyclicBufferAppender 文档</a></li>
<li><a target="_blank" rel="noopener" href="https://logback.qos.ch/manual/appenders.html" title="ListAppender 文档">ListAppender 文档</a></li>
</ul>
<h3 id="UnsynchronizedAppenderBase"><a href="#UnsynchronizedAppenderBase" class="headerlink" title="UnsynchronizedAppenderBase"></a>UnsynchronizedAppenderBase</h3><p><code>UnsynchronizedAppenderBase</code>与<code>AppenderBase</code>相似，唯一不同的就是它的<code>doAppend</code>方法没有使用<code>synchronized</code>进行修饰，这也表名需要它的派生类自己去处理线程安全问题。</p>
<p><img src="/2022/04/25/log-logback3/002.png" alt="Appender 类图" title="Appender 类图"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 源码 ch.qos.logback.core.UnsynchronizedAppenderBase</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnsynchronizedAppenderBase</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">ContextAwareBase</span> <span class="keyword">implements</span> <span class="title">Appender</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">boolean</span> started = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// using a ThreadLocal instead of a boolean add 75 nanoseconds per</span></span><br><span class="line">    <span class="comment">// doAppend invocation. This is tolerable as doAppend takes at least a few microseconds</span></span><br><span class="line">    <span class="comment">// on a real appender</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The guard prevents an appender from repeatedly calling its own doAppend</span></span><br><span class="line"><span class="comment">     * method.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> ThreadLocal&lt;Boolean&gt; guard = <span class="keyword">new</span> ThreadLocal&lt;Boolean&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Appenders are named.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> FilterAttachableImpl&lt;E&gt; fai = <span class="keyword">new</span> FilterAttachableImpl&lt;E&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> statusRepeatCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> exceptionCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ALLOWED_REPEATS = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAppend</span><span class="params">(E eventObject)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// WARNING: The guard check MUST be the first statement in the</span></span><br><span class="line">        <span class="comment">// doAppend() method.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// prevent re-entry.</span></span><br><span class="line">        <span class="keyword">if</span> (Boolean.TRUE.equals(guard.get())) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            guard.set(Boolean.TRUE);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.started) &#123;</span><br><span class="line">                <span class="keyword">if</span> (statusRepeatCount++ &lt; ALLOWED_REPEATS) &#123;</span><br><span class="line">                    addStatus(<span class="keyword">new</span> WarnStatus(<span class="string">&quot;Attempted to append to non started appender [&quot;</span> + name + <span class="string">&quot;].&quot;</span>, <span class="keyword">this</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (getFilterChainDecision(eventObject) == FilterReply.DENY) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ok, we now invoke derived class&#x27; implementation of append</span></span><br><span class="line">            <span class="keyword">this</span>.append(eventObject);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (exceptionCount++ &lt; ALLOWED_REPEATS) &#123;</span><br><span class="line">                addError(<span class="string">&quot;Appender [&quot;</span> + name + <span class="string">&quot;] failed to append.&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            guard.set(Boolean.FALSE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">append</span><span class="params">(E eventObject)</span></span>;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>UnsynchronizedAppenderBase</code>的派生类有：</p>
<ul>
<li>AsyncAppender：异步记录日志事件</li>
<li>ConsoleAppender：控制台记录日志事件</li>
<li>FileAppender：文件记录日志事件</li>
<li>RollingFileAppender：滚动文件记录日志事件</li>
</ul>
<h4 id="AsyncAppender"><a href="#AsyncAppender" class="headerlink" title="AsyncAppender"></a>AsyncAppender</h4><p>我们不能单独的使用<code>AsyncAppender</code>，<code>AsyncAppender</code>在启动的时候会创建一个工作线程，同时会有一个本地队列，当有日志事件进入时，<code>AsyncAppender</code>会把日志事件放入到本地队列中，然后worker线程会去队列头部取出日志事件然后再委派给真正的appender去记录日志事件。值得注意的是，当本地队列超过80%时，<code>AsyncAppender</code>会丢弃掉<code>TRACE</code>、<code>DEBUG</code>和<code>INFO</code>级别的日志事件。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;FILE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.FileAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">file</span>&gt;</span>myapp.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%-4relative [%thread] %-5level %logger&#123;30&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;ASYNC&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.AsyncAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;ASYNC&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="ConsoleAppender"><a href="#ConsoleAppender" class="headerlink" title="ConsoleAppender"></a>ConsoleAppender</h4><p><code>ConsoleAppender</code>是将日志事件记录到控制台，更准确的说是记录到<code>System.out</code>或者<code>System.err</code>，默认是记录到<code>System.out</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 源码 ch.qos.logback.core.ConsoleAppender</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsoleAppender</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">OutputStreamAppender</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> ConsoleTarget target = ConsoleTarget.SystemOut;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">boolean</span> withJansi = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String WindowsAnsiOutputStream_CLASS_NAME = <span class="string">&quot;org.fusesource.jansi.WindowsAnsiOutputStream&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets the value of the &lt;b&gt;Target&lt;/b&gt; option. Recognized values are</span></span><br><span class="line"><span class="comment">     * &quot;System.out&quot; and &quot;System.err&quot;. Any other value will be ignored.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTarget</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">        ConsoleTarget t = ConsoleTarget.findByName(value.trim());</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123;</span><br><span class="line">            targetWarn(value);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            target = t;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the current value of the &lt;b&gt;target&lt;/b&gt; property. The default value</span></span><br><span class="line"><span class="comment">     * of the option is &quot;System.out&quot;.</span></span><br><span class="line"><span class="comment">     * &lt;p/&gt;</span></span><br><span class="line"><span class="comment">     * See also &#123;<span class="doctag">@link</span> #setTarget&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTarget</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> target.getName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">targetWarn</span><span class="params">(String val)</span> </span>&#123;</span><br><span class="line">        Status status = <span class="keyword">new</span> WarnStatus(<span class="string">&quot;[&quot;</span> + val + <span class="string">&quot;] should be one of &quot;</span> + Arrays.toString(ConsoleTarget.values()), <span class="keyword">this</span>);</span><br><span class="line">        status.add(<span class="keyword">new</span> WarnStatus(<span class="string">&quot;Using previously set target, System.out by default.&quot;</span>, <span class="keyword">this</span>));</span><br><span class="line">        addStatus(status);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        OutputStream targetStream = target.getStream();</span><br><span class="line">        <span class="comment">// enable jansi only on Windows and only if withJansi set to true</span></span><br><span class="line">        <span class="keyword">if</span> (EnvUtil.isWindows() &amp;&amp; withJansi) &#123;</span><br><span class="line">            targetStream = getTargetStreamForWindows(targetStream);</span><br><span class="line">        &#125;</span><br><span class="line">        setOutputStream(targetStream);</span><br><span class="line">        <span class="keyword">super</span>.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> OutputStream <span class="title">getTargetStreamForWindows</span><span class="params">(OutputStream targetStream)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            addInfo(<span class="string">&quot;Enabling JANSI WindowsAnsiOutputStream for the console.&quot;</span>);</span><br><span class="line">            Object windowsAnsiOutputStream = OptionHelper.instantiateByClassNameAndParameter(WindowsAnsiOutputStream_CLASS_NAME, Object.class, context,</span><br><span class="line">                            OutputStream.class, targetStream);</span><br><span class="line">            <span class="keyword">return</span> (OutputStream) windowsAnsiOutputStream;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            addWarn(<span class="string">&quot;Failed to create WindowsAnsiOutputStream. Falling back on the default stream.&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> targetStream;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isWithJansi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> withJansi;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * If true, this appender will output to a stream which</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> withJansi</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 1.0.5</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWithJansi</span><span class="params">(<span class="keyword">boolean</span> withJansi)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.withJansi = withJansi;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;STDOUT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- encoders are assigned the type</span></span><br><span class="line"><span class="comment">         ch.qos.logback.classic.encoder.PatternLayoutEncoder by default --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%-4relative [%thread] %-5level %logger&#123;35&#125; - %msg %n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="FileAppender"><a href="#FileAppender" class="headerlink" title="FileAppender"></a>FileAppender</h4><p><code>FileAppender</code>它将日志事件记录到文件中，也是开发中经常用到的。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;FILE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.FileAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">file</span>&gt;</span>testFile.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">append</span>&gt;</span>true<span class="tag">&lt;/<span class="name">append</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- set immediateFlush to false for much higher logging throughput --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">immediateFlush</span>&gt;</span>true<span class="tag">&lt;/<span class="name">immediateFlush</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- encoders are assigned the type</span></span><br><span class="line"><span class="comment">         ch.qos.logback.classic.encoder.PatternLayoutEncoder by default --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%-4relative [%thread] %-5level %logger&#123;35&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">  <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="RollingFileAppender"><a href="#RollingFileAppender" class="headerlink" title="RollingFileAppender"></a>RollingFileAppender</h4><p><code>RollingFileAppender</code>继承了<code>FileAppender</code>并对其进行了功能增强，它能对日志文件按配置的策略进行切割。在一般的应用服务中，我们都会使用<code>RollingFileAppender</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 源码 ch.qos.logback.core.rolling.RollingFileAppender</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RollingFileAppender</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">FileAppender</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    File currentlyActiveFile;</span><br><span class="line">    TriggeringPolicy&lt;E&gt; triggeringPolicy;</span><br><span class="line">    RollingPolicy rollingPolicy;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">private</span> String RFA_NO_TP_URL = CODES_URL + <span class="string">&quot;#rfa_no_tp&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">private</span> String RFA_NO_RP_URL = CODES_URL + <span class="string">&quot;#rfa_no_rp&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">private</span> String COLLISION_URL = CODES_URL + <span class="string">&quot;#rfa_collision&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">private</span> String RFA_LATE_FILE_URL = CODES_URL + <span class="string">&quot;#rfa_file_after&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (triggeringPolicy == <span class="keyword">null</span>) &#123;</span><br><span class="line">            addWarn(<span class="string">&quot;No TriggeringPolicy was set for the RollingFileAppender named &quot;</span> + getName());</span><br><span class="line">            addWarn(MORE_INFO_PREFIX + RFA_NO_TP_URL);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!triggeringPolicy.isStarted()) &#123;</span><br><span class="line">            addWarn(<span class="string">&quot;TriggeringPolicy has not started. RollingFileAppender will not start&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (checkForCollisionsInPreviousRollingFileAppenders()) &#123;</span><br><span class="line">            addError(<span class="string">&quot;Collisions detected with FileAppender/RollingAppender instances defined earlier. Aborting.&quot;</span>);</span><br><span class="line">            addError(MORE_INFO_PREFIX + COLLISION_WITH_EARLIER_APPENDER_URL);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// we don&#x27;t want to void existing log files</span></span><br><span class="line">        <span class="keyword">if</span> (!append) &#123;</span><br><span class="line">            addWarn(<span class="string">&quot;Append mode is mandatory for RollingFileAppender. Defaulting to append=true.&quot;</span>);</span><br><span class="line">            append = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rollingPolicy == <span class="keyword">null</span>) &#123;</span><br><span class="line">            addError(<span class="string">&quot;No RollingPolicy was set for the RollingFileAppender named &quot;</span> + getName());</span><br><span class="line">            addError(MORE_INFO_PREFIX + RFA_NO_RP_URL);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// sanity check for http://jira.qos.ch/browse/LOGBACK-796</span></span><br><span class="line">        <span class="keyword">if</span> (checkForFileAndPatternCollisions()) &#123;</span><br><span class="line">            addError(<span class="string">&quot;File property collides with fileNamePattern. Aborting.&quot;</span>);</span><br><span class="line">            addError(MORE_INFO_PREFIX + COLLISION_URL);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isPrudent()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (rawFileProperty() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                addWarn(<span class="string">&quot;Setting \&quot;File\&quot; property to null on account of prudent mode&quot;</span>);</span><br><span class="line">                setFile(<span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (rollingPolicy.getCompressionMode() != CompressionMode.NONE) &#123;</span><br><span class="line">                addError(<span class="string">&quot;Compression is not supported in prudent mode. Aborting&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        currentlyActiveFile = <span class="keyword">new</span> File(getFile());</span><br><span class="line">        addInfo(<span class="string">&quot;Active log file name: &quot;</span> + getFile());</span><br><span class="line">        <span class="keyword">super</span>.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;FILE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">file</span>&gt;</span>logFile.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- daily rollover --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>logFile.%d&#123;yyyy-MM-dd&#125;.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">&lt;!-- keep 30 days&#x27; worth of history capped at 3GB total size --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>30<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">totalSizeCap</span>&gt;</span>3GB<span class="tag">&lt;/<span class="name">totalSizeCap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%-4relative [%thread] %-5level %logger&#123;35&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span> </span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>从源码中我们可以看到，相比于<code>FileAppender</code>，<code>RollingFileAppender</code>增加了<code>RollingPolicy</code>与<code>TriggeringPolicy</code>，它们定义了什么时候去滚动日志文件以及如何去滚动日志文件。</p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>除了上面文中罗列的一些<code>Appender</code>，还有很多扩展的appender，比如<code>logback-access-db</code>中的<code>DBAppender</code>，我们也可以去自定义我们的appender。实际生产项目中，我们使用得最多的应该是<code>RollingFileAppender</code>。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/java/" rel="tag"># java</a>
              <a href="/tags/%E6%97%A5%E5%BF%97%E7%BB%84%E4%BB%B6/" rel="tag"># 日志组件</a>
              <a href="/tags/logback/" rel="tag"># logback</a>
              <a href="/tags/appender/" rel="tag"># appender</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/04/18/log-logback2/" rel="prev" title="日志组件Logback之Logger">
      <i class="fa fa-chevron-left"></i> 日志组件Logback之Logger
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/05/02/log-logback4/" rel="next" title="日志组件Logback之Layout">
      日志组件Logback之Layout <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB"><span class="nav-number">2.</span> <span class="nav-text">源码解读</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Appender"><span class="nav-number">2.1.</span> <span class="nav-text">Appender</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AppenderBase"><span class="nav-number">2.2.</span> <span class="nav-text">AppenderBase</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SocketAppender%E4%B8%8ESSLSocketAppender"><span class="nav-number">2.2.1.</span> <span class="nav-text">SocketAppender与SSLSocketAppender</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ServerSocketAppender%E4%B8%8ESSLServerSocketAppender"><span class="nav-number">2.2.2.</span> <span class="nav-text">ServerSocketAppender与SSLServerSocketAppender</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SMTPAppender"><span class="nav-number">2.2.3.</span> <span class="nav-text">SMTPAppender</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SiftingAppender"><span class="nav-number">2.2.4.</span> <span class="nav-text">SiftingAppender</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B6%E5%AE%83"><span class="nav-number">2.2.5.</span> <span class="nav-text">其它</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UnsynchronizedAppenderBase"><span class="nav-number">2.3.</span> <span class="nav-text">UnsynchronizedAppenderBase</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#AsyncAppender"><span class="nav-number">2.3.1.</span> <span class="nav-text">AsyncAppender</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ConsoleAppender"><span class="nav-number">2.3.2.</span> <span class="nav-text">ConsoleAppender</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#FileAppender"><span class="nav-number">2.3.3.</span> <span class="nav-text">FileAppender</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RollingFileAppender"><span class="nav-number">2.3.4.</span> <span class="nav-text">RollingFileAppender</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%93%E8%AF%AD"><span class="nav-number">3.</span> <span class="nav-text">结语</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="victor min"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">victor min</p>
  <div class="site-description" itemprop="description">风无定，人无常<br/>人生如浮萍，聚散两茫茫</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">15</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ldmzw" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ldmzw" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:happy0mzw@qq.com" title="E-Mail → mailto:happy0mzw@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">victor min</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
