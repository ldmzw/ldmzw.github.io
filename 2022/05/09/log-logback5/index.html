<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"ldmzw.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":true,"nav":{"gitalk":{"order":-2}}},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="概述在前面的文章中，我们已经介绍了logback的Logger、Appender与Layout组件，通过上面的组件，我们可以轻松熟练的使用logback。logback除了上面的几种组件，还给我们提供了Filter组件。本篇文章主要介绍Filter组件。 在logback-classic中提供了两种类型的filter：regular filter和turbo filter。每个filter提供了d">
<meta property="og:type" content="article">
<meta property="og:title" content="日志组件Logback之Filter">
<meta property="og:url" content="http://ldmzw.github.io/2022/05/09/log-logback5/index.html">
<meta property="og:site_name" content="ldmzw">
<meta property="og:description" content="概述在前面的文章中，我们已经介绍了logback的Logger、Appender与Layout组件，通过上面的组件，我们可以轻松熟练的使用logback。logback除了上面的几种组件，还给我们提供了Filter组件。本篇文章主要介绍Filter组件。 在logback-classic中提供了两种类型的filter：regular filter和turbo filter。每个filter提供了d">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://ldmzw.github.io/2022/05/09/log-logback5/001.png">
<meta property="og:image" content="http://ldmzw.github.io/2022/05/09/log-logback5/002.png">
<meta property="og:image" content="http://ldmzw.github.io/2022/05/09/log-logback5/003.png">
<meta property="og:image" content="http://ldmzw.github.io/2022/05/09/log-logback5/004.png">
<meta property="article:published_time" content="2022-05-09T12:51:03.000Z">
<meta property="article:modified_time" content="2022-06-14T06:42:40.109Z">
<meta property="article:author" content="victor min">
<meta property="article:tag" content="java">
<meta property="article:tag" content="日志组件">
<meta property="article:tag" content="logback">
<meta property="article:tag" content="filter">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://ldmzw.github.io/2022/05/09/log-logback5/001.png">

<link rel="canonical" href="http://ldmzw.github.io/2022/05/09/log-logback5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>日志组件Logback之Filter | ldmzw</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?871d14f3134a97b6f6c8ad66f8875178";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ldmzw</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">趣谈闲记</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/ldmzw" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://ldmzw.github.io/2022/05/09/log-logback5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="victor min">
      <meta itemprop="description" content="风无定，人无常<br/>人生如浮萍，聚散两茫茫">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ldmzw">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          日志组件Logback之Filter
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-05-09 20:51:03" itemprop="dateCreated datePublished" datetime="2022-05-09T20:51:03+08:00">2022-05-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-06-14 14:42:40" itemprop="dateModified" datetime="2022-06-14T14:42:40+08:00">2022-06-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/%E6%97%A5%E5%BF%97%E7%BB%84%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">日志组件</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/%E6%97%A5%E5%BF%97%E7%BB%84%E4%BB%B6/logback/" itemprop="url" rel="index"><span itemprop="name">logback</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>在前面的文章中，我们已经介绍了<code>logback</code>的<code>Logger</code>、<code>Appender</code>与<code>Layout</code>组件，通过上面的组件，我们可以轻松熟练的使用<code>logback</code>。<code>logback</code>除了上面的几种组件，还给我们提供了<code>Filter</code>组件。本篇文章主要介绍<code>Filter</code>组件。</p>
<p>在<code>logback-classic</code>中提供了两种类型的filter：<code>regular filter</code>和<code>turbo filter</code>。每个<code>filter</code>提供了<code>decide(ILoggingEvent event)</code>方法来决定日志事件是否需要处理，<code>decide</code>方法会返回一个<code>FilterReply</code>枚举值，包含：<code>DENY</code>、<code>NEUTRAL</code>和<code>ACCEPT</code>。多个<code>filter</code>通过串联的方式可以组成一组过滤规则。</p>
<ul>
<li><p>DENY：日志事件会被立即丢弃，不再执行剩余的<code>filter</code>的<code>decide</code>方法</p>
</li>
<li><p>NEUTRAL：日志事件会被传递到下一个<code>filter</code>中，并通过执行<code>decide</code>方法来确认日志的处理策略</p>
</li>
<li><p>ACCEPT：日志事件会被立即处理，不再执行剩余的<code>filter</code>的<code>decide</code>方法</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://logback.qos.ch/" title="Logback 官网">Logback 官网</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://logback.qos.ch/manual/index.html" title="Logback 使用手册">Logback 使用手册</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://logback.qos.ch/manual/filters.html" title="Logback Filter使用手册">Logback Filter使用手册</a></p>
</li>
</ul>
<p>系列相关文章：</p>
<ul>
<li><a href="/2022/02/28/log-framework/" title="日志组件">日志组件</a></li>
<li><a href="/2022/03/07/log-logback/" title="日志组件Logback">日志组件Logback</a></li>
<li><a href="/2022/03/21/log-framework1/" title="日志组件动态日志">日志组件动态日志</a></li>
<li><a href="/2022/04/18/log-logback2/" title="日志组件Logback之Logger">日志组件Logback之Logger</a></li>
<li><a href="/2022/04/25/log-logback3/" title="日志组件Logback之Appender">日志组件Logback之Appender</a></li>
<li><a href="/2022/05/02/log-logback4/" title="日志组件Logback之Layout">日志组件Logback之Layout</a></li>
<li><a href="/2022/05/09/log-logback5/" title="日志组件Logback之Filter">日志组件Logback之Filter</a></li>
<li><a href="/2022/05/16/log-logback6/" title="日志组件Logback之配置加载">日志组件Logback之配置加载</a></li>
<li><a href="/2022/05/23/log-logback7/" title="日志组件Logback之配置加载">日志组件Logback之配置加载</a></li>
</ul>
<span id="more"></span>

<h2 id="regular-filter"><a href="#regular-filter" class="headerlink" title="regular filter"></a>regular filter</h2><p><code>regular filter</code>的作用域是在<code>appender</code>中，它是与<code>appender</code>进行绑定的，对进入<code>appender</code>中的日志事件进行过滤处理。所有的<code>regular filter</code>都继承自<code>ch.qos.logback.core.filter.Filter</code>，主要包含：<code>ThresholdFilter</code>、<code>LevelFilter</code>与<code>EvaluatorFilter</code>。</p>
<p><img src="/2022/05/09/log-logback5/001.png" alt="Filter 类图" title="Filter 类图"></p>
<h3 id="ThresholdFilter"><a href="#ThresholdFilter" class="headerlink" title="ThresholdFilter"></a>ThresholdFilter</h3><p><code>ThresholdFilter</code>即阀值filter或者说是阈值filter，当日志事件等级大于等于当前配置的日志等级时，会返回<code>NEUTRAL</code>，否则会返回<code>DENY</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 源码：ch.qos.logback.core.filter.Filter</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThresholdFilter</span> <span class="keyword">extends</span> <span class="title">Filter</span>&lt;<span class="title">ILoggingEvent</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    Level level;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterReply <span class="title">decide</span><span class="params">(ILoggingEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!isStarted()) &#123;</span><br><span class="line">            <span class="keyword">return</span> FilterReply.NEUTRAL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (event.getLevel().isGreaterOrEqual(level)) &#123;</span><br><span class="line">            <span class="keyword">return</span> FilterReply.NEUTRAL;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> FilterReply.DENY;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLevel</span><span class="params">(String level)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.level = Level.toLevel(level);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.level != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">super</span>.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;CONSOLE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- deny all events with a level below INFO, that is TRACE and DEBUG --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.ThresholdFilter&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">level</span>&gt;</span>INFO<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%-4relative [%thread] %-5level %logger&#123;30&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;CONSOLE&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="LevelFilter"><a href="#LevelFilter" class="headerlink" title="LevelFilter"></a>LevelFilter</h3><p><code>LevelFilter</code>与<code>ThresholdFilter</code>有点相似，都是根据日志事件的等级来决定如何处理日志事件，不同的是<code>LevelFilter</code>在判断日志等级时是使用等于来判断，同时它提供了<code>onMatch</code>与<code>onMissmatch</code>让使用者来自定义处理结果，默认都是<code>NEUTRAL</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 源码：ch.qos.logback.classic.filter.LevelFilter</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LevelFilter</span> <span class="keyword">extends</span> <span class="title">AbstractMatcherFilter</span>&lt;<span class="title">ILoggingEvent</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    Level level;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterReply <span class="title">decide</span><span class="params">(ILoggingEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!isStarted()) &#123;</span><br><span class="line">            <span class="keyword">return</span> FilterReply.NEUTRAL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (event.getLevel().equals(level)) &#123;</span><br><span class="line">            <span class="keyword">return</span> onMatch;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> onMismatch;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLevel</span><span class="params">(Level level)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.level = level;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.level != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">super</span>.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 源码：ch.qos.logback.core.filter.AbstractMatcherFilter</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractMatcherFilter</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">Filter</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> FilterReply onMatch = FilterReply.NEUTRAL;</span><br><span class="line">    <span class="keyword">protected</span> FilterReply onMismatch = FilterReply.NEUTRAL;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnMatch</span><span class="params">(FilterReply reply)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.onMatch = reply;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnMismatch</span><span class="params">(FilterReply reply)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.onMismatch = reply;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">public</span> FilterReply <span class="title">getOnMatch</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> onMatch;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">public</span> FilterReply <span class="title">getOnMismatch</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> onMismatch;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;CONSOLE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">level</span>&gt;</span>INFO<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%-4relative [%thread] %-5level %logger&#123;30&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;CONSOLE&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="EvaluatorFilter"><a href="#EvaluatorFilter" class="headerlink" title="EvaluatorFilter"></a>EvaluatorFilter</h3><p><code>EvaluatorFilter</code>与上面的两种filter有所不同，我们可以认为<code>ThresholdFilter</code>与<code>LevelFilter</code>是一种特殊的<code>EvaluatorFilter</code>，主要是依据日志事件等级来判断的。<code>EvaluatorFilter</code>是一个通用的filter，它包含了一个<code>EventEvaluator</code>对象。<code>EventEvaluator</code>对象负责过滤条件的判断，过滤的结果由<code>onMatch</code>和<code>onMismatch</code>这两个属性决定。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 源码：ch.qos.logback.core.filter.EvaluatorFilter</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EvaluatorFilter</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractMatcherFilter</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    EventEvaluator&lt;E&gt; evaluator;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (evaluator != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">super</span>.start();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            addError(<span class="string">&quot;No evaluator set for filter &quot;</span> + <span class="keyword">this</span>.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EventEvaluator&lt;E&gt; <span class="title">getEvaluator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> evaluator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEvaluator</span><span class="params">(EventEvaluator&lt;E&gt; evaluator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.evaluator = evaluator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterReply <span class="title">decide</span><span class="params">(E event)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// let us not throw an exception</span></span><br><span class="line">        <span class="comment">// see also bug #17.</span></span><br><span class="line">        <span class="keyword">if</span> (!isStarted() || !evaluator.isStarted()) &#123;</span><br><span class="line">            <span class="keyword">return</span> FilterReply.NEUTRAL;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (evaluator.evaluate(event)) &#123;</span><br><span class="line">                <span class="keyword">return</span> onMatch;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> onMismatch;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (EvaluationException e) &#123;</span><br><span class="line">            addError(<span class="string">&quot;Evaluator &quot;</span> + evaluator.getName() + <span class="string">&quot; threw an exception&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> FilterReply.NEUTRAL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="EventEvaluator"><a href="#EventEvaluator" class="headerlink" title="EventEvaluator"></a>EventEvaluator</h4><p><code>EventEvaluator</code>允许我们自己去定义更复杂的日志事件处理策略，我们可以编写自己的表达式与方法来决定如何处理日志事件。<code>logback</code>默认提供了<code>OnErrorEvaluator</code>、<code>OnMarkerEvaluator</code>与<code>JaninoEventEvaluator</code>。</p>
<p><img src="/2022/05/09/log-logback5/002.png" alt="EventEvaluator 类图" title="EventEvaluator 类图"></p>
<h4 id="OnErrorEvaluator"><a href="#OnErrorEvaluator" class="headerlink" title="OnErrorEvaluator"></a>OnErrorEvaluator</h4><p><code>OnErrorEvaluator</code>可以理解为一个特殊的<code>ThresholdFilter</code>处理逻辑，当日志事件等大于等于<code>ERROR</code>时，匹配<code>onMatch</code>，否则匹配<code>onMissmatch</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 源码：ch.qos.logback.classic.boolex.OnErrorEvaluator</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OnErrorEvaluator</span> <span class="keyword">extends</span> <span class="title">EventEvaluatorBase</span>&lt;<span class="title">ILoggingEvent</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return true if event passed as parameter has level ERROR or higher, returns</span></span><br><span class="line"><span class="comment">     * false otherwise.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">evaluate</span><span class="params">(ILoggingEvent event)</span> <span class="keyword">throws</span> NullPointerException, EvaluationException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> event.getLevel().levelInt &gt;= Level.ERROR_INT;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;CONSOLE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.filter.EvaluatorFilter&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">evaluator</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.boolex.OnErrorEvaluator&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%-4relative [%thread] %-5level %logger&#123;30&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;CONSOLE&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="OnMarkerEvaluator"><a href="#OnMarkerEvaluator" class="headerlink" title="OnMarkerEvaluator"></a>OnMarkerEvaluator</h4><p><code>OnMarkerEvaluator</code>是根据日志事件中的<code>Marker</code>来进行判断，只要包含我们配置的任意一个，都会返回true。我们知道<code>marker</code>是可以增加<code>子marker</code>的，当去判断日志事件的marker是否包含指定的值时，会递归去判断<code>子marker</code>是否包含我们指定的值，只要有一个<code>子marker</code>判断成功，则都会返回成功，与Stream.anyMatch()类似。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 源码：ch.qos.logback.classic.boolex.OnMarkerEvaluator</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OnMarkerEvaluator</span> <span class="keyword">extends</span> <span class="title">EventEvaluatorBase</span>&lt;<span class="title">ILoggingEvent</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; markerList = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMarker</span><span class="params">(String markerStr)</span> </span>&#123;</span><br><span class="line">        markerList.add(markerStr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return true if event passed as parameter contains one of the specified</span></span><br><span class="line"><span class="comment">     * user-markers.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">evaluate</span><span class="params">(ILoggingEvent event)</span> <span class="keyword">throws</span> NullPointerException, EvaluationException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Marker eventsMarker = event.getMarker();</span><br><span class="line">        <span class="keyword">if</span> (eventsMarker == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (String markerStr : markerList) &#123;</span><br><span class="line">            <span class="keyword">if</span> (eventsMarker.contains(markerStr)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 源码：org.slf4j.helpers.BasicMarker</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicMarker</span> <span class="keyword">implements</span> <span class="title">Marker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">2849567615646933777L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Marker&gt; referenceList = <span class="keyword">new</span> CopyOnWriteArrayList&lt;Marker&gt;();</span><br><span class="line"></span><br><span class="line">    BasicMarker(String name) &#123;</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;A marker name cannot be null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Marker reference)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (reference == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;A null value cannot be added to a Marker as reference.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// no point in adding the reference multiple times</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.contains(reference)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (reference.contains(<span class="keyword">this</span>)) &#123; <span class="comment">// avoid recursion</span></span><br><span class="line">            <span class="comment">// a potential reference should not hold its future &quot;parent&quot; as a reference</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            referenceList.add(reference);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This method is mainly used with Expression Evaluators.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Other cannot be null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.name.equals(name)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (hasReferences()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Marker ref : referenceList) &#123; <span class="comment">//@1</span></span><br><span class="line">                <span class="keyword">if</span> (ref.contains(name)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String OPEN = <span class="string">&quot;[ &quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String CLOSE = <span class="string">&quot; ]&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String SEP = <span class="string">&quot;, &quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="comment">//@2</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.hasReferences()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.getName();</span><br><span class="line">        &#125;</span><br><span class="line">        Iterator&lt;Marker&gt; it = <span class="keyword">this</span>.iterator();</span><br><span class="line">        Marker reference;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder(<span class="keyword">this</span>.getName());</span><br><span class="line">        sb.append(<span class="string">&#x27; &#x27;</span>).append(OPEN);</span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">            reference = it.next();</span><br><span class="line">            sb.append(reference.getName());</span><br><span class="line">            <span class="keyword">if</span> (it.hasNext()) &#123;</span><br><span class="line">                sb.append(SEP);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sb.append(CLOSE);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>@1：在contains方法中，我们看到会取出所有children进行判断，只要有其中一个child匹配成功则会返回成功</li>
<li>@2：toString方法会在<code>ch.qos.logback.classic.pattern.MarkerConverter</code>中被调用，从这儿我们也可以了解到<code>%marker</code>最后的显示格式为<code>parentName [ child1, child2, child3 ]</code></li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;CONSOLE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.filter.EvaluatorFilter&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">evaluator</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.boolex.OnMarkerEvaluator&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">marker</span>&gt;</span>xxx<span class="tag">&lt;/<span class="name">marker</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">marker</span>&gt;</span>yyy<span class="tag">&lt;/<span class="name">marker</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">evaluator</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%-4relative [%thread] %-5level %logger&#123;30&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;CONSOLE&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果使用<code>marker</code>，我们需要在打印日志的时候增加<code>marker</code>。示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Marker m = MarkerFactory.getMarker(<span class="string">&quot;test&quot;</span>);</span><br><span class="line"></span><br><span class="line">  Marker xxx = MarkerFactory.getMarker(<span class="string">&quot;xxx&quot;</span>);</span><br><span class="line">  m.add(xxx);</span><br><span class="line">  Marker zzz = MarkerFactory.getMarker(<span class="string">&quot;zzz&quot;</span>);</span><br><span class="line">  m.add(zzz);</span><br><span class="line"></span><br><span class="line">  Marker m2 = MarkerFactory.getMarker(<span class="string">&quot;yyy&quot;</span>);</span><br><span class="line"></span><br><span class="line">  org.slf4j.Logger log = org.slf4j.LoggerFactory.getLogger(MTest.class);</span><br><span class="line">  log.trace(<span class="string">&quot;level is: &#123;&#125;&quot;</span>, <span class="string">&quot;trace&quot;</span>);</span><br><span class="line">  log.debug(m, <span class="string">&quot;level is: &#123;&#125;&quot;</span>, <span class="string">&quot;debug&quot;</span>);</span><br><span class="line">  log.info(<span class="string">&quot;level is: &#123;&#125;&quot;</span>, <span class="string">&quot;info&quot;</span>);</span><br><span class="line">  log.warn(m, <span class="string">&quot;level is: &#123;&#125;&quot;</span>, <span class="string">&quot;warn&quot;</span>);</span><br><span class="line">  log.error(m2, <span class="string">&quot;level is: &#123;&#125;&quot;</span>, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们运行上面的示例，将会得到如下结果：</p>
<p><img src="/2022/05/09/log-logback5/003.png" alt="OnMarkerEvaluator 测试图" title="OnMarkerEvaluator 测试图"></p>
<h4 id="JaninoEventEvaluator"><a href="#JaninoEventEvaluator" class="headerlink" title="JaninoEventEvaluator"></a>JaninoEventEvaluator</h4><p><code>JaninoEventEvaluator</code>可以允许使用者提供一段java代码，logback会运行使用者提供的java代码段然后根据结果来决策日志事件的处理。需要注意的是，如果我们使用<code>JaninoEventEvaluator</code>，我们需要引入<code>janino</code>依赖包。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 源码：ch.qos.logback.classic.boolex.JaninoEventEvaluator</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JaninoEventEvaluator</span> <span class="keyword">extends</span> <span class="title">JaninoEventEvaluatorBase</span>&lt;<span class="title">ILoggingEvent</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String IMPORT_LEVEL = <span class="string">&quot;import ch.qos.logback.classic.Level;\r\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> List&lt;String&gt; DEFAULT_PARAM_NAME_LIST = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> List&lt;Class&gt; DEFAULT_PARAM_TYPE_LIST = <span class="keyword">new</span> ArrayList&lt;Class&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        DEFAULT_PARAM_NAME_LIST.add(<span class="string">&quot;DEBUG&quot;</span>);</span><br><span class="line">        DEFAULT_PARAM_NAME_LIST.add(<span class="string">&quot;INFO&quot;</span>);</span><br><span class="line">        DEFAULT_PARAM_NAME_LIST.add(<span class="string">&quot;WARN&quot;</span>);</span><br><span class="line">        DEFAULT_PARAM_NAME_LIST.add(<span class="string">&quot;ERROR&quot;</span>);</span><br><span class="line"></span><br><span class="line">        DEFAULT_PARAM_NAME_LIST.add(<span class="string">&quot;event&quot;</span>);</span><br><span class="line">        DEFAULT_PARAM_NAME_LIST.add(<span class="string">&quot;message&quot;</span>);</span><br><span class="line"></span><br><span class="line">        DEFAULT_PARAM_NAME_LIST.add(<span class="string">&quot;formattedMessage&quot;</span>);</span><br><span class="line">        DEFAULT_PARAM_NAME_LIST.add(<span class="string">&quot;logger&quot;</span>);</span><br><span class="line">        DEFAULT_PARAM_NAME_LIST.add(<span class="string">&quot;loggerContext&quot;</span>);</span><br><span class="line">        DEFAULT_PARAM_NAME_LIST.add(<span class="string">&quot;level&quot;</span>);</span><br><span class="line">        DEFAULT_PARAM_NAME_LIST.add(<span class="string">&quot;timeStamp&quot;</span>);</span><br><span class="line">        DEFAULT_PARAM_NAME_LIST.add(<span class="string">&quot;marker&quot;</span>);</span><br><span class="line">        DEFAULT_PARAM_NAME_LIST.add(<span class="string">&quot;mdc&quot;</span>);</span><br><span class="line">        DEFAULT_PARAM_NAME_LIST.add(<span class="string">&quot;throwableProxy&quot;</span>);</span><br><span class="line">        DEFAULT_PARAM_NAME_LIST.add(<span class="string">&quot;throwable&quot;</span>);</span><br><span class="line"></span><br><span class="line">        DEFAULT_PARAM_TYPE_LIST.add(<span class="keyword">int</span>.class);</span><br><span class="line">        DEFAULT_PARAM_TYPE_LIST.add(<span class="keyword">int</span>.class);</span><br><span class="line">        DEFAULT_PARAM_TYPE_LIST.add(<span class="keyword">int</span>.class);</span><br><span class="line">        DEFAULT_PARAM_TYPE_LIST.add(<span class="keyword">int</span>.class);</span><br><span class="line"></span><br><span class="line">        DEFAULT_PARAM_TYPE_LIST.add(ILoggingEvent.class);</span><br><span class="line">        DEFAULT_PARAM_TYPE_LIST.add(String.class);</span><br><span class="line">        DEFAULT_PARAM_TYPE_LIST.add(String.class);</span><br><span class="line">        DEFAULT_PARAM_TYPE_LIST.add(String.class);</span><br><span class="line">        DEFAULT_PARAM_TYPE_LIST.add(LoggerContextVO.class);</span><br><span class="line">        DEFAULT_PARAM_TYPE_LIST.add(<span class="keyword">int</span>.class);</span><br><span class="line">        DEFAULT_PARAM_TYPE_LIST.add(<span class="keyword">long</span>.class);</span><br><span class="line">        DEFAULT_PARAM_TYPE_LIST.add(Marker.class);</span><br><span class="line">        DEFAULT_PARAM_TYPE_LIST.add(Map.class);</span><br><span class="line">        DEFAULT_PARAM_TYPE_LIST.add(IThrowableProxy.class);</span><br><span class="line">        DEFAULT_PARAM_TYPE_LIST.add(Throwable.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getDecoratedExpression</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String expression = getExpression();</span><br><span class="line">        <span class="keyword">if</span> (!expression.contains(<span class="string">&quot;return&quot;</span>)) &#123;</span><br><span class="line">            expression = <span class="string">&quot;return &quot;</span> + expression + <span class="string">&quot;;&quot;</span>;</span><br><span class="line">            addInfo(<span class="string">&quot;Adding [return] prefix and a semicolon suffix. Expression becomes [&quot;</span> + expression + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">            addInfo(<span class="string">&quot;See also &quot;</span> + CoreConstants.CODES_URL + <span class="string">&quot;#block&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> IMPORT_LEVEL + expression;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>增加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.codehaus.janino<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>janino<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;STDOUT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.filter.EvaluatorFilter&quot;</span>&gt;</span>      </span><br><span class="line">      <span class="tag">&lt;<span class="name">evaluator</span>&gt;</span> <span class="comment">&lt;!-- defaults to type ch.qos.logback.classic.boolex.JaninoEventEvaluator --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">expression</span>&gt;</span>return message.contains(&quot;billing&quot;);<span class="tag">&lt;/<span class="name">expression</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">evaluator</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">OnMismatch</span>&gt;</span>NEUTRAL<span class="tag">&lt;/<span class="name">OnMismatch</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">OnMatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">OnMatch</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%-4relative [%thread] %-5level %logger&#123;30&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们看到上面的示例配置中增加了<code>&lt;expression&gt;</code>，在<code>JaninoEventEvaluator#getDecoratedExpression</code>会获取我们自己定义的<code>expression</code>,最后会调用<code>org.codehaus.janino.ScriptEvaluator#evaluate</code>去执行我们的代码片段。在上面的代码片段中，我们使用了<code>message</code>变量，<code>JaninoEventEvaluator</code>为我们提供了如下变量。</p>
<table>
<thead>
<tr>
<th align="center">变量名称</th>
<th align="center">变量类型</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">event</td>
<td align="center">LoggingEvent</td>
<td align="center">日志事件,下面所有的变量都可以从日志事件中获取。如<code>message</code>变量与<code>event.getMessage()</code>是相同的内容</td>
</tr>
<tr>
<td align="center">message</td>
<td align="center">String</td>
<td align="center">原始日志消息，如我们调用<code>log.info(&quot;hello &#123;&#125;&quot;, &quot;victor min&quot;)</code>，此时的<code>message</code>变量内容为<code>hello &#123;&#125;</code></td>
</tr>
<tr>
<td align="center">formattedMessage</td>
<td align="center">String</td>
<td align="center">格式化后的日志消息，如我们调用<code>log.info(&quot;hello &#123;&#125;&quot;, &quot;victor min&quot;)</code>，此时的<code>formattedMessage</code>变量内容为<code>hello victor min</code></td>
</tr>
<tr>
<td align="center">logger</td>
<td align="center">String</td>
<td align="center">logger的名称</td>
</tr>
<tr>
<td align="center">loggerContext</td>
<td align="center">LoggerContextVO</td>
<td align="center">logger关联的logger context</td>
</tr>
<tr>
<td align="center">level</td>
<td align="center">int</td>
<td align="center">日志事件等级</td>
</tr>
<tr>
<td align="center">timeStamp</td>
<td align="center">long</td>
<td align="center">日志事件创建时的时间</td>
</tr>
<tr>
<td align="center">marker</td>
<td align="center">Marker</td>
<td align="center">日志事件的Marker。注意，日志事件的Marker可能为<code>null</code>，所以在使用的时候我们应该做出判断来避免出现<code>NullPointerException</code></td>
</tr>
<tr>
<td align="center">mdc</td>
<td align="center">Map</td>
<td align="center">所有的 MDC。在logback-classic 0.9.30之后，调用<code>mdc.get(&quot;xxx&quot;)</code>永远不会返回null，同时<code>mdc.get(&quot;xxx&quot;)</code>返回的类型为<code>Object</code>，如果我们需要是<code>String</code>则需要进行类型转换，如<code>((String) mdc.get(&quot;xxx&quot;)).contains(&quot;val&quot;)</code></td>
</tr>
<tr>
<td align="center">throwable</td>
<td align="center">java.lang.Throwable</td>
<td align="center">日志事件的异常，如果没有异常则为<code>null</code>。<code>throwable</code>变量在序列化时会被丢弃，因此，在远程系统中，它的值永远都是<code>null</code>。在表达式中，我们尽量使用<code>throwableProxy</code>变量</td>
</tr>
<tr>
<td align="center">throwableProxy</td>
<td align="center">IThrowableProxy</td>
<td align="center">日志事件的代理异常，如果日志事件本身也不存异常，则变量为<code>null</code>。如果日志事件存在异常，即使序列化后，在远程系统中，<code>throwableProxy</code>也不会为空</td>
</tr>
</tbody></table>
<p>在使用<code>&lt;expression&gt;</code>编写我们自己的代码片段时，如果我们有调用<code>String#matches()</code>做正则匹配时，则每次<code>filter</code>被调用时都会编译正则表达式生成一个新的<code>Pattern</code>对象，为了消除这种开销，我们可以预定义一个或者多个<code>Matcher</code>对象。只要当我们定义了一个<code>Matcher</code>对象后，我们就可以通过名称在`<expression>代码片段中重复使用。</p>
<p>举例：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">debug</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;STDOUT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.filter.EvaluatorFilter&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">evaluator</span>&gt;</span>        </span><br><span class="line">        <span class="tag">&lt;<span class="name">matcher</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">Name</span>&gt;</span>odd<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">          <span class="comment">&lt;!-- filter out odd numbered statements --&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">regex</span>&gt;</span>statement [13579]<span class="tag">&lt;/<span class="name">regex</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">matcher</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">expression</span>&gt;</span>odd.matches(formattedMessage)<span class="tag">&lt;/<span class="name">expression</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">evaluator</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">OnMismatch</span>&gt;</span>NEUTRAL<span class="tag">&lt;/<span class="name">OnMismatch</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">OnMatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">OnMatch</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%-4relative [%thread] %-5level %logger - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="turbo-filter"><a href="#turbo-filter" class="headerlink" title="turbo filter"></a>turbo filter</h2><p><code>turbo filter</code>都继承自<code>ch.qos.logback.classic.turbo.TurboFilter</code>，和<code>regular filter</code>一样，它也是通过调用<code>decide</code>方法返回<code>FilterReply</code>枚举值。</p>
<p><code>turbo filter</code>与<code>regular filter</code>的不同之处在于：</p>
<ul>
<li><code>turbo filter</code>是作用于<code>loggerContext</code>上，也就是会过滤所有的logging request</li>
<li><code>turbo filter</code>会在<code>LoggingEvent</code>之前创建，也就是说当过滤一个logging request时，<code>turbo filter</code>不需要<code>loggingEvent</code>实例，并且它拥有很高的优先级</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// ch.qos.logback.core.filter.Filter</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> FilterReply <span class="title">decide</span><span class="params">(E event)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ch.qos.logback.classic.turbo.TurboFilter</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> FilterReply <span class="title">decide</span><span class="params">(Marker marker, Logger logger, Level level, String format, Object[] params, Throwable t)</span></span></span><br><span class="line"><span class="function"></span></span><br></pre></td></tr></table></figure>

<p>从源码我们也能看出，<code>regular filter</code>的<code>decide</code>方法参数为<code>event</code>，而<code>turbo filter</code>的参数则为<code>marker</code>、<code>logger</code>等。</p>
<p><img src="/2022/05/09/log-logback5/004.png" alt="TurboFilter 类图" title="TurboFilter 类图"></p>
<h3 id="MatchingFilter"><a href="#MatchingFilter" class="headerlink" title="MatchingFilter"></a>MatchingFilter</h3><p><code>MatchingFilter</code>包含<code>ch.qos.logback.classic.turbo.MDCFilter</code>与<code>ch.qos.logback.classic.turbo.MarkerFilter</code>，它们的逻辑都比较简单，<code>MDCFilter</code>是从<code>MDC</code>中获取值进行判断，而<code>MarkerFilter</code>则是根据<code>marker</code>来进行判断。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 源码：ch.qos.logback.classic.turbo.MDCFilter</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MDCFilter</span> <span class="keyword">extends</span> <span class="title">MatchingFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String MDCKey;</span><br><span class="line">    String value;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterReply <span class="title">decide</span><span class="params">(Marker marker, Logger logger, Level level, String format, Object[] params, Throwable t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (MDCKey == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> FilterReply.NEUTRAL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String value = MDC.get(MDCKey);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.value.equals(value)) &#123;</span><br><span class="line">            <span class="keyword">return</span> onMatch;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> onMismatch;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMDCKey</span><span class="params">(String MDCKey)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.MDCKey = MDCKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 源码：ch.qos.logback.classic.turbo.MarkerFilter</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MarkerFilter</span> <span class="keyword">extends</span> <span class="title">MatchingFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Marker markerToMatch;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (markerToMatch != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">super</span>.start();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            addError(<span class="string">&quot;The marker property must be set for [&quot;</span> + getName() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterReply <span class="title">decide</span><span class="params">(Marker marker, Logger logger, Level level, String format, Object[] params, Throwable t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!isStarted()) &#123;</span><br><span class="line">            <span class="keyword">return</span> FilterReply.NEUTRAL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (marker == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> onMismatch;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (marker.contains(markerToMatch)) &#123;</span><br><span class="line">            <span class="keyword">return</span> onMatch;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> onMismatch;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The marker to match in the event.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> markerStr</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMarker</span><span class="params">(String markerStr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (markerStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.markerToMatch = MarkerFactory.getMarker(markerStr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">turboFilter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.turbo.MDCFilter&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">MDCKey</span>&gt;</span>username<span class="tag">&lt;/<span class="name">MDCKey</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Value</span>&gt;</span>victor min<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">OnMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">OnMatch</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">turboFilter</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">  <span class="tag">&lt;<span class="name">turboFilter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.turbo.MarkerFilter&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Marker</span>&gt;</span>billing<span class="tag">&lt;/<span class="name">Marker</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">OnMatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">OnMatch</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">turboFilter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;console&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%-4relative [%thread] %-5level %logger&#123;30&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;console&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">root</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="DynamicThresholdFilter"><a href="#DynamicThresholdFilter" class="headerlink" title="DynamicThresholdFilter"></a>DynamicThresholdFilter</h3><p><code>DynamicThresholdFilter</code>可以让我们根据<code>MDC</code>里面的内容去动态的打印不同等级的日志。比同根据用户不同，打印日志的等级也不同。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 源码：ch.qos.logback.classic.turbo.DynamicThresholdFilter</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicThresholdFilter</span> <span class="keyword">extends</span> <span class="title">TurboFilter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Level&gt; valueLevelMap = <span class="keyword">new</span> HashMap&lt;String, Level&gt;();</span><br><span class="line">    <span class="keyword">private</span> Level defaultThreshold = Level.ERROR;</span><br><span class="line">    <span class="keyword">private</span> String key;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> FilterReply onHigherOrEqual = FilterReply.NEUTRAL;</span><br><span class="line">    <span class="keyword">private</span> FilterReply onLower = FilterReply.DENY;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the MDC key whose value will be used as a level threshold</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the name of the MDC key.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> setKey</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setKey</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the default threshold value when the MDC key is not set.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the default threshold value in the absence of a set MDC key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Level <span class="title">getDefaultThreshold</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> defaultThreshold;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDefaultThreshold</span><span class="params">(Level defaultThreshold)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.defaultThreshold = defaultThreshold;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the FilterReply when the effective level is higher or equal to the</span></span><br><span class="line"><span class="comment">     * level of current logging request</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> FilterReply</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterReply <span class="title">getOnHigherOrEqual</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> onHigherOrEqual;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnHigherOrEqual</span><span class="params">(FilterReply onHigherOrEqual)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.onHigherOrEqual = onHigherOrEqual;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the FilterReply when the effective level is lower than the level of</span></span><br><span class="line"><span class="comment">     * current logging request</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> FilterReply</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterReply <span class="title">getOnLower</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> onLower;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnLower</span><span class="params">(FilterReply onLower)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.onLower = onLower;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Add a new MDCValuePair</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMDCValueLevelPair</span><span class="params">(MDCValueLevelPair mdcValueLevelPair)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (valueLevelMap.containsKey(mdcValueLevelPair.getValue())) &#123;</span><br><span class="line">            addError(mdcValueLevelPair.getValue() + <span class="string">&quot; has been already set&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            valueLevelMap.put(mdcValueLevelPair.getValue(), mdcValueLevelPair.getLevel());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.key == <span class="keyword">null</span>) &#123;</span><br><span class="line">            addError(<span class="string">&quot;No key name was specified&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">super</span>.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This method first finds the MDC value for &#x27;key&#x27;. It then finds the level</span></span><br><span class="line"><span class="comment">     * threshold associated with this MDC value from the list of MDCValueLevelPair</span></span><br><span class="line"><span class="comment">     * passed to this filter. This value is stored in a variable called</span></span><br><span class="line"><span class="comment">     * &#x27;levelAssociatedWithMDCValue&#x27;. If it null, then it is set to the</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @&#123;link #defaultThreshold&#125; value.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * If no such value exists, then</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> marker</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> logger</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> level</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> s</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objects</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> throwable</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> FilterReply - this filter&#x27;s decision</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterReply <span class="title">decide</span><span class="params">(Marker marker, Logger logger, Level level, String s, Object[] objects, Throwable throwable)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String mdcValue = MDC.get(<span class="keyword">this</span>.key);</span><br><span class="line">        <span class="keyword">if</span> (!isStarted()) &#123;</span><br><span class="line">            <span class="keyword">return</span> FilterReply.NEUTRAL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Level levelAssociatedWithMDCValue = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (mdcValue != <span class="keyword">null</span>) &#123;</span><br><span class="line">            levelAssociatedWithMDCValue = valueLevelMap.get(mdcValue);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (levelAssociatedWithMDCValue == <span class="keyword">null</span>) &#123;</span><br><span class="line">            levelAssociatedWithMDCValue = defaultThreshold;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (level.isGreaterOrEqual(levelAssociatedWithMDCValue)) &#123;</span><br><span class="line">            <span class="keyword">return</span> onHigherOrEqual;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> onLower;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">turboFilter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.turbo.DynamicThresholdFilter&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Key</span>&gt;</span>userId<span class="tag">&lt;/<span class="name">Key</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">DefaultThreshold</span>&gt;</span>ERROR<span class="tag">&lt;/<span class="name">DefaultThreshold</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">OnHigherOrEqual</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">OnHigherOrEqual</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">OnLower</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">OnLower</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">MDCValueLevelPair</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>user1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>DEBUG<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">MDCValueLevelPair</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">MDCValueLevelPair</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>user2<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>INFO<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">MDCValueLevelPair</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">turboFilter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;CONSOLE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>INFO<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%-4relative [%thread] %-5level %logger&#123;30&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;CONSOLE&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在上面的配置中，当我们在MDC中加入<code>userId</code>为<code>user1</code>时，会打印<code>DEBUG</code>及以上等级的日志，当为<code>user2</code>时，只会打印<code>INFO</code>及以上等级的日志。</p>
<h3 id="DuplicateMessageFilter"><a href="#DuplicateMessageFilter" class="headerlink" title="DuplicateMessageFilter"></a>DuplicateMessageFilter</h3><p><code>DuplicateMessageFilter</code>会检查日志事件消息是否重复，当重复超过一定次数，直接丢弃掉日志事件。需要注意的，通过源码我们可以看出，它是根据日志事件的<code>format</code>进行检测的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 下面的两条消息会认为是不是重复的</span></span><br><span class="line">log.debug(<span class="string">&quot;Hello &quot;</span>+name0);</span><br><span class="line">log.debug(<span class="string">&quot;Hello &quot;</span>+name1);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 下面的两条消息会认为是不是重复的，因为`format`都是`Hello &#123;&#125;.`</span></span><br><span class="line">log.debug(<span class="string">&quot;Hello &#123;&#125;.&quot;</span>, name0);</span><br><span class="line">log.debug(<span class="string">&quot;Hello &#123;&#125;.&quot;</span>, name1);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 源码：ch.qos.logback.classic.turbo.DuplicateMessageFilter</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DuplicateMessageFilter</span> <span class="keyword">extends</span> <span class="title">TurboFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The default cache size.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_CACHE_SIZE = <span class="number">100</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The default number of allows repetitions.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_ALLOWED_REPETITIONS = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> allowedRepetitions = DEFAULT_ALLOWED_REPETITIONS;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> cacheSize = DEFAULT_CACHE_SIZE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LRUMessageCache msgCache;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        msgCache = <span class="keyword">new</span> LRUMessageCache(cacheSize);</span><br><span class="line">        <span class="keyword">super</span>.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        msgCache.clear();</span><br><span class="line">        msgCache = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">super</span>.stop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterReply <span class="title">decide</span><span class="params">(Marker marker, Logger logger, Level level, String format, Object[] params, Throwable t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> count = msgCache.getMessageCountAndThenIncrement(format);</span><br><span class="line">        <span class="keyword">if</span> (count &lt;= allowedRepetitions) &#123;</span><br><span class="line">            <span class="keyword">return</span> FilterReply.NEUTRAL;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> FilterReply.DENY;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAllowedRepetitions</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> allowedRepetitions;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The allowed number of repetitions before</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> allowedRepetitions</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAllowedRepetitions</span><span class="params">(<span class="keyword">int</span> allowedRepetitions)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.allowedRepetitions = allowedRepetitions;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCacheSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cacheSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCacheSize</span><span class="params">(<span class="keyword">int</span> cacheSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.cacheSize = cacheSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">turboFilter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.turbo.DuplicateMessageFilter&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;console&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%-4relative [%thread] %-5level %logger&#123;30&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;console&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">root</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="ReconfigureOnChangeFilter"><a href="#ReconfigureOnChangeFilter" class="headerlink" title="ReconfigureOnChangeFilter"></a>ReconfigureOnChangeFilter</h3><p><code>ReconfigureOnChangeFilter</code>会重新配置<code>loggerContext</code>当日志配置文件发生变化时。它与我们配置文件中的 <code>&lt;configuration scan=&quot;true&quot;&gt;</code>有关。我们知道<code>turbo filter</code>会处理每个日志事件，因此<code>ReconfigureOnChangeFilter</code>不会每次都去检测配置文件是否更新，而是每16次日志请求会去检查一次配置文件是否更新。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 源码：ch.qos.logback.classic.turbo.ReconfigureOnChangeFilter</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReconfigureOnChangeFilter</span> <span class="keyword">extends</span> <span class="title">TurboFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Scan for changes in configuration file once every minute.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 1 minute - value mentioned in documentation</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> DEFAULT_REFRESH_PERIOD = <span class="number">60</span> * MILLIS_IN_ONE_SECOND;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> refreshPeriod = DEFAULT_REFRESH_PERIOD;</span><br><span class="line">    URL mainConfigurationURL;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">volatile</span> <span class="keyword">long</span> nextCheck;</span><br><span class="line"></span><br><span class="line">    ConfigurationWatchList configurationWatchList;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        configurationWatchList = ConfigurationWatchListUtil.getConfigurationWatchList(context);</span><br><span class="line">        <span class="keyword">if</span> (configurationWatchList != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mainConfigurationURL = configurationWatchList.getMainURL();</span><br><span class="line">            <span class="keyword">if</span> (mainConfigurationURL == <span class="keyword">null</span>) &#123;</span><br><span class="line">                addWarn(<span class="string">&quot;Due to missing top level configuration file, automatic reconfiguration is impossible.&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            List&lt;File&gt; watchList = configurationWatchList.getCopyOfFileWatchList();</span><br><span class="line">            <span class="keyword">long</span> inSeconds = refreshPeriod / <span class="number">1000</span>;</span><br><span class="line">            addInfo(<span class="string">&quot;Will scan for changes in [&quot;</span> + watchList + <span class="string">&quot;] every &quot;</span> + inSeconds + <span class="string">&quot; seconds. &quot;</span>);</span><br><span class="line">            <span class="keyword">synchronized</span> (configurationWatchList) &#123;</span><br><span class="line">                updateNextCheck(System.currentTimeMillis());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">super</span>.start();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            addWarn(<span class="string">&quot;Empty ConfigurationWatchList in context&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ReconfigureOnChangeFilter&#123;&quot;</span> + <span class="string">&quot;invocationCounter=&quot;</span> + invocationCounter + <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The next fields counts the number of time the decide method is called</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// IMPORTANT: This field can be updated by multiple threads. It follows that</span></span><br><span class="line">    <span class="comment">// its values may *not* be incremented sequentially. However, we don&#x27;t care</span></span><br><span class="line">    <span class="comment">// about the actual value of the field except that from time to time the</span></span><br><span class="line">    <span class="comment">// expression (invocationCounter++ &amp; mask) == mask) should be true.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> invocationCounter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> mask = <span class="number">0xF</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastMaskCheck = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterReply <span class="title">decide</span><span class="params">(Marker marker, Logger logger, Level level, String format, Object[] params, Throwable t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!isStarted()) &#123;</span><br><span class="line">            <span class="keyword">return</span> FilterReply.NEUTRAL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// for performance reasons, skip change detection (MASK-1) times out of MASK.</span></span><br><span class="line">        <span class="comment">// Only once every MASK calls is change detection code executed</span></span><br><span class="line">        <span class="comment">// Note that MASK is a variable itself.</span></span><br><span class="line">        <span class="keyword">if</span> (((invocationCounter++) &amp; mask) != mask) &#123;</span><br><span class="line">            <span class="keyword">return</span> FilterReply.NEUTRAL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (configurationWatchList) &#123;</span><br><span class="line">            updateMaskIfNecessary(now);</span><br><span class="line">            <span class="keyword">if</span> (changeDetected(now)) &#123;</span><br><span class="line">                <span class="comment">// Even though reconfiguration involves resetting the loggerContext,</span></span><br><span class="line">                <span class="comment">// which clears the list of turbo filters including this instance, it is</span></span><br><span class="line">                <span class="comment">// still possible for this instance to be subsequently invoked by another</span></span><br><span class="line">                <span class="comment">// thread if it was already executing when the context was reset.</span></span><br><span class="line">                disableSubsequentReconfiguration();</span><br><span class="line">                detachReconfigurationToNewThread();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> FilterReply.NEUTRAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// experiments indicate that even for CPU intensive applications with 200 or more threads MASK</span></span><br><span class="line">    <span class="comment">// values in the order of 0xFFFF is appropriate</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_MASK = <span class="number">0xFFFF</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if less than MASK_INCREASE_THRESHOLD milliseconds elapse between invocations of updateMaskIfNecessary() method,</span></span><br><span class="line">    <span class="comment">// then the mask should be increased</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MASK_INCREASE_THRESHOLD = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if more than MASK_DECREASE_THRESHOLD milliseconds elapse between invocations of updateMaskIfNecessary() method,</span></span><br><span class="line">    <span class="comment">// then the mask should be decreased</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MASK_DECREASE_THRESHOLD = MASK_INCREASE_THRESHOLD * <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update the mask so as to execute change detection code about once every 100 to 8000 milliseconds.</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateMaskIfNecessary</span><span class="params">(<span class="keyword">long</span> now)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> timeElapsedSinceLastMaskUpdateCheck = now - lastMaskCheck;</span><br><span class="line">        lastMaskCheck = now;</span><br><span class="line">        <span class="keyword">if</span> (timeElapsedSinceLastMaskUpdateCheck &lt; MASK_INCREASE_THRESHOLD &amp;&amp; (mask &lt; MAX_MASK)) &#123;</span><br><span class="line">            mask = (mask &lt;&lt; <span class="number">1</span>) | <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (timeElapsedSinceLastMaskUpdateCheck &gt; MASK_DECREASE_THRESHOLD) &#123;</span><br><span class="line">            mask = mask &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// by detaching reconfiguration to a new thread, we release the various</span></span><br><span class="line">    <span class="comment">// locks held by the current thread, in particular, the AppenderAttachable</span></span><br><span class="line">    <span class="comment">// reader lock.</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">detachReconfigurationToNewThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        addInfo(<span class="string">&quot;Detected change in [&quot;</span> + configurationWatchList.getCopyOfFileWatchList() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        context.getExecutorService().submit(<span class="keyword">new</span> ReconfiguringThread());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateNextCheck</span><span class="params">(<span class="keyword">long</span> now)</span> </span>&#123;</span><br><span class="line">        nextCheck = now + refreshPeriod;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">changeDetected</span><span class="params">(<span class="keyword">long</span> now)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (now &gt;= nextCheck) &#123;</span><br><span class="line">            updateNextCheck(now);</span><br><span class="line">            <span class="keyword">return</span> configurationWatchList.changeDetected();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">disableSubsequentReconfiguration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        nextCheck = Long.MAX_VALUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getRefreshPeriod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> refreshPeriod;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRefreshPeriod</span><span class="params">(<span class="keyword">long</span> refreshPeriod)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.refreshPeriod = refreshPeriod;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ReconfiguringThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (mainConfigurationURL == <span class="keyword">null</span>) &#123;</span><br><span class="line">                addInfo(<span class="string">&quot;Due to missing top level configuration file, skipping reconfiguration&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            LoggerContext lc = (LoggerContext) context;</span><br><span class="line">            addInfo(CoreConstants.RESET_MSG_PREFIX + <span class="string">&quot;named [&quot;</span> + context.getName() + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (mainConfigurationURL.toString().endsWith(<span class="string">&quot;xml&quot;</span>)) &#123;</span><br><span class="line">                performXMLConfiguration(lc);</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performXMLConfiguration</span><span class="params">(LoggerContext lc)</span> </span>&#123;</span><br><span class="line">            JoranConfigurator jc = <span class="keyword">new</span> JoranConfigurator();</span><br><span class="line">            jc.setContext(context);</span><br><span class="line">            StatusUtil statusUtil = <span class="keyword">new</span> StatusUtil(context);</span><br><span class="line">            List&lt;SaxEvent&gt; eventList = jc.recallSafeConfiguration();</span><br><span class="line">            URL mainURL = ConfigurationWatchListUtil.getMainWatchURL(context);</span><br><span class="line">            lc.reset();</span><br><span class="line">            <span class="keyword">long</span> threshold = System.currentTimeMillis();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                jc.doConfigure(mainConfigurationURL);</span><br><span class="line">                <span class="keyword">if</span> (statusUtil.hasXMLParsingErrors(threshold)) &#123;</span><br><span class="line">                    fallbackConfiguration(lc, eventList, mainURL);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (JoranException e) &#123;</span><br><span class="line">                fallbackConfiguration(lc, eventList, mainURL);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fallbackConfiguration</span><span class="params">(LoggerContext lc, List&lt;SaxEvent&gt; eventList, URL mainURL)</span> </span>&#123;</span><br><span class="line">            JoranConfigurator joranConfigurator = <span class="keyword">new</span> JoranConfigurator();</span><br><span class="line">            joranConfigurator.setContext(context);</span><br><span class="line">            <span class="keyword">if</span> (eventList != <span class="keyword">null</span>) &#123;</span><br><span class="line">                addWarn(<span class="string">&quot;Falling back to previously registered safe configuration.&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    lc.reset();</span><br><span class="line">                    JoranConfigurator.informContextOfURLUsedForConfiguration(context, mainURL);</span><br><span class="line">                    joranConfigurator.doConfigure(eventList);</span><br><span class="line">                    addInfo(<span class="string">&quot;Re-registering previous fallback configuration once more as a fallback configuration point&quot;</span>);</span><br><span class="line">                    joranConfigurator.registerSafeConfiguration(eventList);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (JoranException e) &#123;</span><br><span class="line">                    addError(<span class="string">&quot;Unexpected exception thrown by a configuration considered safe.&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                addWarn(<span class="string">&quot;No previous configuration to fall back on.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>通过对<code>filter</code>的学习，开发者能更好的处理日志事件，它能根据开发者们的配置呈现出不同的效果以达到我们的预期。<code>filter</code>可以看作是<code>logback</code>留给开发者们的一个切入点，我们不使用<code>filter</code>也可以实现我们基本的功能需求，但当我们需要实现复杂的需求时，我们就可以配合使用<code>filter</code>来实现，如果还有更复杂的需求，我们甚至可以实现我们自己的<code>filter</code>。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/java/" rel="tag"># java</a>
              <a href="/tags/%E6%97%A5%E5%BF%97%E7%BB%84%E4%BB%B6/" rel="tag"># 日志组件</a>
              <a href="/tags/logback/" rel="tag"># logback</a>
              <a href="/tags/filter/" rel="tag"># filter</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/05/02/log-logback4/" rel="prev" title="日志组件Logback之Layout">
      <i class="fa fa-chevron-left"></i> 日志组件Logback之Layout
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/05/16/log-logback6/" rel="next" title="日志组件Logback之配置加载">
      日志组件Logback之配置加载 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#regular-filter"><span class="nav-number">2.</span> <span class="nav-text">regular filter</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ThresholdFilter"><span class="nav-number">2.1.</span> <span class="nav-text">ThresholdFilter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LevelFilter"><span class="nav-number">2.2.</span> <span class="nav-text">LevelFilter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EvaluatorFilter"><span class="nav-number">2.3.</span> <span class="nav-text">EvaluatorFilter</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#EventEvaluator"><span class="nav-number">2.3.1.</span> <span class="nav-text">EventEvaluator</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#OnErrorEvaluator"><span class="nav-number">2.3.2.</span> <span class="nav-text">OnErrorEvaluator</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#OnMarkerEvaluator"><span class="nav-number">2.3.3.</span> <span class="nav-text">OnMarkerEvaluator</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JaninoEventEvaluator"><span class="nav-number">2.3.4.</span> <span class="nav-text">JaninoEventEvaluator</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#turbo-filter"><span class="nav-number">3.</span> <span class="nav-text">turbo filter</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MatchingFilter"><span class="nav-number">3.1.</span> <span class="nav-text">MatchingFilter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DynamicThresholdFilter"><span class="nav-number">3.2.</span> <span class="nav-text">DynamicThresholdFilter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DuplicateMessageFilter"><span class="nav-number">3.3.</span> <span class="nav-text">DuplicateMessageFilter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ReconfigureOnChangeFilter"><span class="nav-number">3.4.</span> <span class="nav-text">ReconfigureOnChangeFilter</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%93%E8%AF%AD"><span class="nav-number">4.</span> <span class="nav-text">结语</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="victor min"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">victor min</p>
  <div class="site-description" itemprop="description">风无定，人无常<br/>人生如浮萍，聚散两茫茫</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">17</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">31</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ldmzw" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ldmzw" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:happy0mzw@qq.com" title="E-Mail → mailto:happy0mzw@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">victor min</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
